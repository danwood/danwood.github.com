<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
		<meta http-equiv="content-type" content="text/html;charset=ISO-8859-1" />
		<title>Dan Wood: The Eponymous Weblog (Archives) | by Dan Wood, Karelia Software</title>
		<meta name="description" content="Useful Tidbits and Egotistical Musings from Dan Wood, co-owner of Karelia Software. This blog mostly covers geeky topics like Mac Programming." />

<link rel="alternate" type="application/rss+xml" title="RSS" href="http://gigliwood.com/weblog/index.rss" />



<style type="text/css">

/* color palette: tinyurl.com/tgq5o */

body {
	background:#9191FF;
	margin:0;
	padding:0;
	font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size:76%;
	word-wrap:break-word;
	}


pre { word-wrap:normal !important;
		font:9px monaco;
		margin-right:-3px;
	background:white; padding: 3px; overflow:auto; }


.bio { font-size:80%; margin:auto; text-align:center; padding:10px 40px; }
.description { clear:all; color:white; font-weight:bold; font-size:120%; margin:auto; text-align:center; }

.categories { text-align:center; border-top:1px dashed #888; border-bottom:1px dashed #888; }

#frame {
	margin-left:auto;
	margin-right:auto;
	padding:0px;
	width:785px;
	overflow:auto;
	margin-bottom:80px;
	}
	
#heady {
	background:#12127D;
	color:#B37D00;
	padding:20px 10px 10px 10px;
}

#heady a:link              { color:#FFB200; text-decoration:underline; }
#heady a:visited           { color:#FFB200; text-decoration:none; }
#heady a:hover             { color:#C8C8FF; text-decoration:underline; }
#heady a:active            { color:#FFFFFF; text-decoration:underline; }

h1, h2, h3, h4 {
	margin:0;
}

h1 {
	padding-bottom:20px;
	font-weight:normal;
	font-family:Zapfino, Georgia, serif;
	text-shadow:white 0 0 20px;
	text-align:center;
}
	
#contentcenter {
	width: 565px;
	}

div.dateHeader {
	text-align:right;
	padding:5px;
	font-weight:bold;
	}

/* holds one item */
div.item {
	background:white;
	overflow:auto;
	}

/* sub-holds one item */
div.row {
  		}

div.row .label {
		float: left;
		width: 105px;
		}
		
p.postinfo {
		text-align: right;
		padding:10px 10px 5px 5px;
		font-size:70%;
		margin:0;
}
		
.label h2 {
	color:#12127D;
	font-size:140%;
	background:#ffB200;
	text-shadow:white 2 0 2px;
	padding:5px;
	margin:0;
	font-family:Georgia, serif;
	font-weight:normal;
}

.label img {
	padding:3px 0;
}

.label a:link              { color:#1919B3; text-decoration:none; }
.label a:visited           { color:#9191FF; text-decoration:none; }
.label a:hover             { color:#12127D; text-decoration:underline; }
.label a:active            { color:#B37D00; text-decoration:underline; }


div.row .value {
		float: left;
		width: 440px;
		text-align: left;
		padding:0 10px 60px 10px;
		background:#FFECBF;
		font-family:Georgia, serif;  font-size:110%;
		}

.value a:link              { color:#1919B3; text-decoration:none; }
.value a:visited           { color:#9191FF; text-decoration:none; }
.value a:hover             { color:#12127D; text-decoration:underline; }
.value a:active            { color:#B37D00; text-decoration:underline; }


#sidebar {
	background:#FFD980;
	width:200px;
	padding:20px 10px 80px 10px;
	height:100%;
	text-align:center;
	float:right;
	font-size:80%;
	}

#sidebar a:link              { color:#1919B3; font-weight:normal; text-decoration:underline; }
#sidebar a:visited           { color:#9191FF; font-weight:bold; text-decoration:none; }
#sidebar a:hover             { color:#12127D; font-weight:bold; text-decoration:underline; }
#sidebar a:active            { color:#B37D00; font-weight:bold; text-decoration:underline; }
	
div.calendar {
}
table.month-calendar {
	margin-left:auto;
	margin-right:auto;
	width:80%;
}

.month-calendar, .year-calendar {
	border-collapse:	collapse; 
}
.month-calendar-head, .year-calendar-head {
	background:		#cccccc;
	font-size:		110%;
	font-weight:		bold;
}
.month-calendar-day-head, .year-calendar-subhead {
	font-weight:		normal;
}

.month-calendar-day-noday,
.month-calendar-day-link,     .year-calendar-month-link,
.month-calendar-day-nolink,   .year-calendar-month-nolink,
.month-calendar-day-this-day, .year-calendar-this-month,
.month-calendar-day-future,   .year-calendar-month-future  {
	text-align:		center;
}

.month-calendar-day-future, .year-calendar-month-future {
	color:			#83660F;
}

.Saturday, .Sunday {
	background:		#eeeeee;
}

.month-calendar-day-this-day, .year-calendar-this-month {
	background:		#a5e4ff;
}

</style>

</head>

<body>
<div id="frame">
	<div id="heady">
		<h1>Dan Wood: The Eponymous Weblog <span style="font-size:70%;">(Archives)</span></h1>
		<p class="bio">
			<img style="float:right; margin-top:-20px; border:2px solid gray;" src="http://gigliwood.com/weblogpix/dan_wood.jpeg
" alt="Dan Wood" height="82" width="49" />
		<i>Dan Wood is co-owner of <a href="http://www.karelia.com/">Karelia Software</a>, creating programs for the Macintosh computer.  He is the father of two kids, lives in the Bay Area of California USA, and prefers bicycles to cars.  This site is his older weblog, which mostly covers geeky topics like Macs and Mac Programming.  <a href="http://gigliwood.com/blog">Go visit the current blog here.</a></i>
		</p>
		<p class="description">Useful Tidbits and Egotistical Musings from Dan Wood</p>
		<p class="categories"> <em>Categories:</em> 
		<a href="../../../Business/index.html">Business</a> &middot; 
		<a href="../../../MacOSX/index.html">Mac OS X</a> &middot; 
		<a href="../../../Cocoa/index.html">Cocoa Programming</a> &middot; 
		<a href="../../../General/index.html">General</a> &middot; 
		<a href="../../../index.html"><b>All Categories</b></a>
		</p>
	</div>
	<div id="sidebar">
		<h3>Calendar</h3>
		<div class="calendar">
			<table class="month-calendar"><caption class="month-calendar-head"><a title="October 2009 (1)" href="../../../2009/10/index.html">&larr;</a><a title="January 2010 (1)" href="../index.html">January</a><a title="March 2010 (1)" href="../../03/index.html">&rarr;</a></caption>
<tr>
<th class="month-calendar-day-head Sunday">Sun</th>
<th class="month-calendar-day-head Monday">Mon</th>
<th class="month-calendar-day-head Tuesday">Tue</th>
<th class="month-calendar-day-head Wednesday">Wed</th>
<th class="month-calendar-day-head Thursday">Thu</th>
<th class="month-calendar-day-head Friday">Fri</th>
<th class="month-calendar-day-head Saturday">Sat</th>
</tr>
<tr>
<td class="month-calendar-day-noday Sunday">&nbsp;</td>
<td class="month-calendar-day-noday Monday">&nbsp;</td>
<td class="month-calendar-day-noday Tuesday">&nbsp;</td>
<td class="month-calendar-day-noday Wednesday">&nbsp;</td>
<td class="month-calendar-day-noday Thursday">&nbsp;</td>
<td class="month-calendar-day-nolink Friday">1</td>
<td class="month-calendar-day-nolink Saturday">2</td>
</tr>
<tr>
<td class="month-calendar-day-nolink Sunday">3</td>
<td class="month-calendar-day-nolink Monday">4</td>
<td class="month-calendar-day-nolink Tuesday">5</td>
<td class="month-calendar-day-nolink Wednesday">6</td>
<td class="month-calendar-day-nolink Thursday">7</td>
<td class="month-calendar-day-this-day Friday"><a title="Friday, 8 January 2010 (current) (1)" href="index.html">8</a></td>
<td class="month-calendar-day-nolink Saturday">9</td>
</tr>
<tr>
<td class="month-calendar-day-nolink Sunday">10</td>
<td class="month-calendar-day-nolink Monday">11</td>
<td class="month-calendar-day-nolink Tuesday">12</td>
<td class="month-calendar-day-nolink Wednesday">13</td>
<td class="month-calendar-day-nolink Thursday">14</td>
<td class="month-calendar-day-nolink Friday">15</td>
<td class="month-calendar-day-nolink Saturday">16</td>
</tr>
<tr>
<td class="month-calendar-day-nolink Sunday">17</td>
<td class="month-calendar-day-nolink Monday">18</td>
<td class="month-calendar-day-nolink Tuesday">19</td>
<td class="month-calendar-day-nolink Wednesday">20</td>
<td class="month-calendar-day-nolink Thursday">21</td>
<td class="month-calendar-day-nolink Friday">22</td>
<td class="month-calendar-day-nolink Saturday">23</td>
</tr>
<tr>
<td class="month-calendar-day-nolink Sunday">24</td>
<td class="month-calendar-day-nolink Monday">25</td>
<td class="month-calendar-day-nolink Tuesday">26</td>
<td class="month-calendar-day-nolink Wednesday">27</td>
<td class="month-calendar-day-nolink Thursday">28</td>
<td class="month-calendar-day-nolink Friday">29</td>
<td class="month-calendar-day-nolink Saturday">30</td>
</tr>
<tr>
<td class="month-calendar-day-nolink Sunday">31</td>
<td class="month-calendar-day-noday Monday">&nbsp;</td>
<td class="month-calendar-day-noday Tuesday">&nbsp;</td>
<td class="month-calendar-day-noday Wednesday">&nbsp;</td>
<td class="month-calendar-day-noday Thursday">&nbsp;</td>
<td class="month-calendar-day-noday Friday">&nbsp;</td>
<td class="month-calendar-day-noday Saturday">&nbsp;</td>
</tr>
</table>

		</div>

		<h3><a href="http://amzn.com/w/2663V7TM8IKKC">My Amazon WishList</a></h3>


		<p>Subscribe:
		   <a href="http://gigliwood.com/weblog/index.rss" title="RSS Feed for this category; drag link into a news reader program."><img  src="http://gigliwood.com/weblogpix/rss.gif" alt="RSS" border="0" /></a>
		</p>
		<p>
				<a href="mailto: dan at this domain">Feedback</a></i>
		</p>
		
		<p>
			<b>Also on this website</b>
			<a href="http://gigliwood.com/abcd/">A Basic Course in Dvorak</a> &middot;
			<a href="http://gigliwood.com/kenwood/Pickle/">The Pickle Machine</a> &middot;
			<a href="http://gigliwood.com/mentos/">The Mentos Gallery</a> &middot;
			<a href="http://gigliwood.com/tabletester">Cocoa Table Tester</a> &middot;
			<a href="http://gigliwood.com/wedding">Making your Wedding Make a Difference</a> &middot;
			</p>
		<p>
			<b>Sites I also work on</b>
			<a href="http://www.bikealameda.org/">BikeAlameda</a> &middot;
			<a href="http://progala.blogspot.com/">A Progressive Alamedan (my political blog)</a> &middot;
			<a href="http://www.karelia.com/">Karelia Software</a>
		</p>
		
		<p>
			<b>I'm also here:</b>
			<a href="http://twitter.com/danwood">danwood</a> on Twitter
		</p>
	</div> <!-- end sidebar -->

	<div id="contentcenter">





<div class="dateHeader">Fri, 08 Jan 2010</div>
<div class="item">
	<div class="row">
		<div class="label">
			<h2>Converting Rich Text to TEXT/styl resources for an SLA on a Disk Image</h2>
			<p class="postinfo">
				<a href="../../../Cocoa/Converting_Rich_Tex.html">permanent link</a>
				&middot; Topic<a href="../../../Cocoa/">/Cocoa</a>
				<br />
				<a href="../../../Cocoa/"><img border="0" src="http://gigliwood.com/weblogpix/Cocoa.gif" alt="/Cocoa" /></a>
				
			</p>
		</div>
		<div class="value"><p><i><b>Update:</b> <a href="http://brockerhoff.net/">Rainer Brockerhoff</a> told me that you can actually put an 'RTF ' resource in the resource file, rather than TEXT/styl, so it turns out that this is not the easiest solution.</i>
</p>

<p>
One thing that I try to accomplish each January is to update our copyright statements in all the right places. The only straggler that remained was the Software License Agreement that is embedded in our disk images.
</p>
<p>
Unfortunately, the text for this is not stored in any way that makes it easy to update things. The rich text is stored as an old-fashioned Circa 1984 resource fork, as TEXT and styl resources. (Apple's "Software License Agreements for UDIFs" SDK <a href="ftp://ftp.apple.com/developer/Development_Kits/SLAs_for_UDIFs_1.0.dmg">[Download DMG]</a> has all the gory details.)
</p>
<p>
It's barely possible to even edit a resource file nowadays.  There is the open-source <a href="http://resknife.sourceforge.net/">ResKnife</a> but it doesn't seem to have TEXT/styl support.  There's <a href="http://www.ljug.com/sw/resfool.html">ResFool</a>, but at least as of this writing the website isn't even loading.  There are of course options like ResEdit and Resorcerer that one can run under Classic mode from older versions of Mac OS X, but that's not particularly convenient!
</p>
<p>
I really was hoping I could just store our SLA text as rich text (like .rtf files) and have the conversion to the resources handled for me automagically!
</p>
<p>
No wonder many developers use tools like <a href="http://c-command.com/dropdmg/">DropDMG</a> and <a href="http://www.araelium.com/dmgcanvas/">DMGCanvas</a>. The trouble is, we have all of our build/package/upload process as a shell script, run from a build phase on Xcode. So I really needed a scriptable tool to produce the correct resources.
</p>
<p>
I did some digging, and I found a nice hint (at the bottom of <a href="http://www.cocoadev.com/index.pl?ExtractstylResourceFromNSAttributedString">this page</a>) for converting rich text to TEXT/styl resources by using NSPasteboard.  
</p>
<p>
So I whipped up some code that goes something like this.  
</p>

<pre>
int main (int argc, const char * argv[])
{
    NSAutoreleasePool * pool = [[NSAutoreleasePool alloc] init];

	if (2 != argc)
	{
		NSLog(@"Usage: %@ srcpath\n", [[NSString stringWithUTF8String:argv[0]] lastPathComponent]);
		return -1;
	}

	NSString *sourcePath = [NSString stringWithUTF8String:argv[1]];
	NSAttributedString *str = [[NSAttributedString alloc] initWithPath:sourcePath documentAttributes:nil];
	NSData *data = [str RTFFromRange:NSMakeRange(0, [str length]) documentAttributes:nil];

	NSPasteboard *pb = [NSPasteboard generalPasteboard];
	[pb declareTypes:[NSArray arrayWithObject:NSRTFPboardType] owner:nil];
	[pb setData:data forType:NSRTFPboardType];

	NSData *textData  = [pb dataForType:@"CorePasteboardFlavorType 0x54455854"];   // TEXT
	NSData *styleData = [pb dataForType:@"CorePasteboardFlavorType 0x7374796C"];   // styl
</pre>

<p>
All I needed to do was to write the NSData to a ".r" file. I found a bit of code via Google, from an app called 
<a href="http://shigematsu.org/index.php?JPEGBatcherX">JPEGBatcherX</a>.  It looks like the author was doing something similar.  I adapted his <tt>dump_rsrc</tt> method from this source file which was directly indexed by Google: <a href="http://shigematsu.org/index.php?plugin=attach&amp;openfile=rtf2r.m&amp;refer=JPEGBatcherX%2FDevelopment"> rtf2r.m</a>.   (I don't want to reproduce the code here because it's not clear what the copyright on the code is.)
</p>
<p>
So the above function should be able to end like this:
</p>
<pre>
	dump_rsrc("TEXT", textData);
	dump_rsrc("styl", styleData);

	[pool drain];
    return 0;
}
</pre>

<p>
However, I hit a snag. When running on my Intel Mac, this is an invalid 'styl' resource.  I had to dig up an old copy of Resorcerer and run it under Classic on my old G5 to figure out why.
</p>
<p>
A valid 'styl' resource starts something like this:
</p>
<p>
<tt>0060 0000 0000 000F 000C 0400 0100 000C</tt>
</p>
<p>
This corresponds to: 0x0060 style runs, 0x00000000 first offset, 0x000F line height, 0x000C font ascent, 0x0400 font family, 0x0100 char style, 0x000c pixel size, and so forth.
</p>
<p>
However, the style data I was getting from the pasteboard was more like this:
</p>
<p>
<tt>6000 0000 0000 0f00 0C00 0004 0001 0C00</tt>
</p>
<p>
It sure looks like a little-endian <i>vs.</i> big-endian issue.  This perplexed me, considering I was not manipulating numbers; I was just asking the pasteboard for a bit of data that I ought to be able to write into the 'styl' resource.
</p>
<p>
Fortunately Daniel Jalkut <a href="http://twitter.com/danielpunkass/status/7532594215">mentioned</a> some methods that were designed to flip resource data around.  He later <a href="http://twitter.com/danielpunkass/status/7533163887">explained</a> "Apple provided flippers for many common resource types, but left us to our own devices for some of the less common/modern ones."
</p>
<p>
I guess this make a small amount of sense.  Rather than Apple rewriting the resource manager code to deal with endian issues, we just flip the data afterwards. Still, it's a bit tricky if you don't expect that!
</p>
<p>
So all I needed was to copy the bytes to a writeable block and call the appropriate routine to flip them around. Note my <tt>#ifdef</tt> in the code so that in case the code is big-endian, no real flipping will happen.
</p>

<pre>
	int len = [styleData length];
	char *bytes = malloc(len);
	[styleData getBytes:bytes length:len];

	OSStatus status = CoreEndianFlipData (
	  kCoreEndianResourceManagerDomain, //OSType dataDomain,
	  'styl', //OSType dataType,
	  0, //SInt16 id,
	  bytes, //void *data,
	  len, //ByteCount dataLen,
#ifdef __BIG_ENDIAN__
	  true
#else
	  false	//Boolean currentlyNative
#endif
	  );

	NSData *newStyleData = [[[NSData alloc] initWithBytesNoCopy:bytes length:len freeWhenDone:YES] autorelease];
</pre>

<p>
That does the trick! Now all I have to do is to concatenate the TEXT/styl resources produced with this tool to with the other (un-changing) resources I'm storing in a common ".r" file and build them into my disk image, using the 'Rez' tool.
</p>
</div>
	</div>
</div>
	</div> <!-- end contentCenter -->
</div> <!-- end frame -->

</body>
</html>

