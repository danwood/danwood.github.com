<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
		<meta http-equiv="content-type" content="text/html;charset=ISO-8859-1" />
		<title>Dan Wood: The Eponymous Weblog (Archives) | by Dan Wood, Karelia Software</title>
		<meta name="description" content="Useful Tidbits and Egotistical Musings from Dan Wood, co-owner of Karelia Software. This blog mostly covers geeky topics like Mac Programming." />

<link rel="alternate" type="application/rss+xml" title="RSS" href="http://gigliwood.com/weblog/index.rss" />



<style type="text/css">

/* color palette: tinyurl.com/tgq5o */

body {
	background:#9191FF;
	margin:0;
	padding:0;
	font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size:76%;
	word-wrap:break-word;
	}


pre { word-wrap:normal !important;
		font:9px monaco;
		margin-right:-3px;
	background:white; padding: 3px; overflow:auto; }


.bio { font-size:80%; margin:auto; text-align:center; padding:10px 40px; }
.description { clear:all; color:white; font-weight:bold; font-size:120%; margin:auto; text-align:center; }

.categories { text-align:center; border-top:1px dashed #888; border-bottom:1px dashed #888; }

#frame {
	margin-left:auto;
	margin-right:auto;
	padding:0px;
	width:785px;
	overflow:auto;
	margin-bottom:80px;
	}
	
#heady {
	background:#12127D;
	color:#B37D00;
	padding:20px 10px 10px 10px;
}

#heady a:link              { color:#FFB200; text-decoration:underline; }
#heady a:visited           { color:#FFB200; text-decoration:none; }
#heady a:hover             { color:#C8C8FF; text-decoration:underline; }
#heady a:active            { color:#FFFFFF; text-decoration:underline; }

h1, h2, h3, h4 {
	margin:0;
}

h1 {
	padding-bottom:20px;
	font-weight:normal;
	font-family:Zapfino, Georgia, serif;
	text-shadow:white 0 0 20px;
	text-align:center;
}
	
#contentcenter {
	width: 565px;
	}

div.dateHeader {
	text-align:right;
	padding:5px;
	font-weight:bold;
	}

/* holds one item */
div.item {
	background:white;
	overflow:auto;
	}

/* sub-holds one item */
div.row {
  		}

div.row .label {
		float: left;
		width: 105px;
		}
		
p.postinfo {
		text-align: right;
		padding:10px 10px 5px 5px;
		font-size:70%;
		margin:0;
}
		
.label h2 {
	color:#12127D;
	font-size:140%;
	background:#ffB200;
	text-shadow:white 2 0 2px;
	padding:5px;
	margin:0;
	font-family:Georgia, serif;
	font-weight:normal;
}

.label img {
	padding:3px 0;
}

.label a:link              { color:#1919B3; text-decoration:none; }
.label a:visited           { color:#9191FF; text-decoration:none; }
.label a:hover             { color:#12127D; text-decoration:underline; }
.label a:active            { color:#B37D00; text-decoration:underline; }


div.row .value {
		float: left;
		width: 440px;
		text-align: left;
		padding:0 10px 60px 10px;
		background:#FFECBF;
		font-family:Georgia, serif;  font-size:110%;
		}

.value a:link              { color:#1919B3; text-decoration:none; }
.value a:visited           { color:#9191FF; text-decoration:none; }
.value a:hover             { color:#12127D; text-decoration:underline; }
.value a:active            { color:#B37D00; text-decoration:underline; }


#sidebar {
	background:#FFD980;
	width:200px;
	padding:20px 10px 80px 10px;
	height:100%;
	text-align:center;
	float:right;
	font-size:80%;
	}

#sidebar a:link              { color:#1919B3; font-weight:normal; text-decoration:underline; }
#sidebar a:visited           { color:#9191FF; font-weight:bold; text-decoration:none; }
#sidebar a:hover             { color:#12127D; font-weight:bold; text-decoration:underline; }
#sidebar a:active            { color:#B37D00; font-weight:bold; text-decoration:underline; }
	
div.calendar {
}
table.month-calendar {
	margin-left:auto;
	margin-right:auto;
	width:80%;
}

.month-calendar, .year-calendar {
	border-collapse:	collapse; 
}
.month-calendar-head, .year-calendar-head {
	background:		#cccccc;
	font-size:		110%;
	font-weight:		bold;
}
.month-calendar-day-head, .year-calendar-subhead {
	font-weight:		normal;
}

.month-calendar-day-noday,
.month-calendar-day-link,     .year-calendar-month-link,
.month-calendar-day-nolink,   .year-calendar-month-nolink,
.month-calendar-day-this-day, .year-calendar-this-month,
.month-calendar-day-future,   .year-calendar-month-future  {
	text-align:		center;
}

.month-calendar-day-future, .year-calendar-month-future {
	color:			#83660F;
}

.Saturday, .Sunday {
	background:		#eeeeee;
}

.month-calendar-day-this-day, .year-calendar-this-month {
	background:		#a5e4ff;
}

</style>

</head>

<body>
<div id="frame">
	<div id="heady">
		<h1>Dan Wood: The Eponymous Weblog <span style="font-size:70%;">(Archives)</span></h1>
		<p class="bio">
			<img style="float:right; margin-top:-20px; border:2px solid gray;" src="http://gigliwood.com/weblogpix/dan_wood.jpeg
" alt="Dan Wood" height="82" width="49" />
		<i>Dan Wood is co-owner of <a href="http://www.karelia.com/">Karelia Software</a>, creating programs for the Macintosh computer.  He is the father of two kids, lives in the Bay Area of California USA, and prefers bicycles to cars.  This site is his older weblog, which mostly covers geeky topics like Macs and Mac Programming.  <a href="http://gigliwood.com/blog">Go visit the current blog here.</a></i>
		</p>
		<p class="description">Useful Tidbits and Egotistical Musings from Dan Wood</p>
		<p class="categories"> <em>Categories:</em> 
		<a href="../Business/index.html">Business</a> &middot; 
		<a href="../MacOSX/index.html">Mac OS X</a> &middot; 
		<a href="index.html">Cocoa Programming</a> &middot; 
		<a href="../General/index.html">General</a> &middot; 
		<a href="../index.html"><b>All Categories</b></a>
		</p>
	</div>
	<div id="sidebar">
		<h3>Calendar</h3>
		<div class="calendar">
			<table class="month-calendar"><caption class="month-calendar-head"><a title="January 2007 (10)" href="../2007/01/index.html">&larr;</a><a title="February 2007 (5)" href="../2007/02/index.html">February</a><a title="March 2007 (3)" href="../2007/03/index.html">&rarr;</a></caption>
<tr>
<th class="month-calendar-day-head Sunday">Sun</th>
<th class="month-calendar-day-head Monday">Mon</th>
<th class="month-calendar-day-head Tuesday">Tue</th>
<th class="month-calendar-day-head Wednesday">Wed</th>
<th class="month-calendar-day-head Thursday">Thu</th>
<th class="month-calendar-day-head Friday">Fri</th>
<th class="month-calendar-day-head Saturday">Sat</th>
</tr>
<tr>
<td class="month-calendar-day-noday Sunday">&nbsp;</td>
<td class="month-calendar-day-noday Monday">&nbsp;</td>
<td class="month-calendar-day-noday Tuesday">&nbsp;</td>
<td class="month-calendar-day-noday Wednesday">&nbsp;</td>
<td class="month-calendar-day-nolink Thursday">1</td>
<td class="month-calendar-day-nolink Friday">2</td>
<td class="month-calendar-day-nolink Saturday">3</td>
</tr>
<tr>
<td class="month-calendar-day-link Sunday"><a title="Sunday, 4 February 2007 (1)" href="../2007/02/04/index.html">4</a></td>
<td class="month-calendar-day-nolink Monday">5</td>
<td class="month-calendar-day-link Tuesday"><a title="Tuesday, 6 February 2007 (1)" href="../2007/02/06/index.html">6</a></td>
<td class="month-calendar-day-link Wednesday"><a title="Wednesday, 7 February 2007 (1)" href="../2007/02/07/index.html">7</a></td>
<td class="month-calendar-day-nolink Thursday">8</td>
<td class="month-calendar-day-nolink Friday">9</td>
<td class="month-calendar-day-nolink Saturday">10</td>
</tr>
<tr>
<td class="month-calendar-day-nolink Sunday">11</td>
<td class="month-calendar-day-nolink Monday">12</td>
<td class="month-calendar-day-nolink Tuesday">13</td>
<td class="month-calendar-day-nolink Wednesday">14</td>
<td class="month-calendar-day-nolink Thursday">15</td>
<td class="month-calendar-day-nolink Friday">16</td>
<td class="month-calendar-day-nolink Saturday">17</td>
</tr>
<tr>
<td class="month-calendar-day-nolink Sunday">18</td>
<td class="month-calendar-day-nolink Monday">19</td>
<td class="month-calendar-day-nolink Tuesday">20</td>
<td class="month-calendar-day-nolink Wednesday">21</td>
<td class="month-calendar-day-nolink Thursday">22</td>
<td class="month-calendar-day-nolink Friday">23</td>
<td class="month-calendar-day-nolink Saturday">24</td>
</tr>
<tr>
<td class="month-calendar-day-nolink Sunday">25</td>
<td class="month-calendar-day-nolink Monday">26</td>
<td class="month-calendar-day-nolink Tuesday">27</td>
<td class="month-calendar-day-this-day Wednesday"><a title="Wednesday, 28 February 2007 (current) (2)" href="../2007/02/28/index.html">28</a></td>
<td class="month-calendar-day-noday Thursday">&nbsp;</td>
<td class="month-calendar-day-noday Friday">&nbsp;</td>
<td class="month-calendar-day-noday Saturday">&nbsp;</td>
</tr>
</table>

		</div>

		<h3><a href="http://amzn.com/w/2663V7TM8IKKC">My Amazon WishList</a></h3>


		<p>Subscribe:
		   <a href="http://gigliwood.com/weblog/index.rss" title="RSS Feed for this category; drag link into a news reader program."><img  src="http://gigliwood.com/weblogpix/rss.gif" alt="RSS" border="0" /></a>
		</p>
		<p>
				<a href="mailto: dan at this domain">Feedback</a></i>
		</p>
		
		<p>
			<b>Also on this website</b>
			<a href="http://gigliwood.com/abcd/">A Basic Course in Dvorak</a> &middot;
			<a href="http://gigliwood.com/kenwood/Pickle/">The Pickle Machine</a> &middot;
			<a href="http://gigliwood.com/mentos/">The Mentos Gallery</a> &middot;
			<a href="http://gigliwood.com/tabletester">Cocoa Table Tester</a> &middot;
			<a href="http://gigliwood.com/wedding">Making your Wedding Make a Difference</a> &middot;
			</p>
		<p>
			<b>Sites I also work on</b>
			<a href="http://www.bikealameda.org/">BikeAlameda</a> &middot;
			<a href="http://progala.blogspot.com/">A Progressive Alamedan (my political blog)</a> &middot;
			<a href="http://www.karelia.com/">Karelia Software</a>
		</p>
		
		<p>
			<b>I'm also here:</b>
			<a href="http://twitter.com/danwood">danwood</a> on Twitter
		</p>
	</div> <!-- end sidebar -->

	<div id="contentcenter">





<div class="dateHeader">Wed, 28 Feb 2007</div>
<div class="item">
	<div class="row">
		<div class="label">
			<h2>File Caching, take 2: using NSURLCache directly</h2>
			<p class="postinfo">
				<a href="File_Caching,_take_.html">permanent link</a>
				&middot; Topic<a href="../Cocoa/">/Cocoa</a>
				<br />
				<a href="../Cocoa/"><img border="0" src="http://gigliwood.com/weblogpix/Cocoa.gif" alt="/Cocoa" /></a>
				
			</p>
		</div>
		<div class="value"><p>
Recently I blogged about a <a href="File_Caching_Schemes.html">home-spun cache technique</a>.  After some discussion in the comments, <a href="http://robertblum.com">Robert Blum</a> sent me a snippet of code which uses <b>NSURLCache</b>  and related classes.  I had no idea these classes could really be used for anything outside of the URL loading system, so I explored them a bit further, and with the help of some other <a href="http://www.cocoabuilder.com/archive/message/cocoa/2003/7/14/73912">code I found on CocoaBuilder</a>, I got something working.
</p>
<p>
I've defined two category methods on <b>NSURLCache</b>. My code calls <tt>cachedDataForPath:</tt> to look and see if the data have already been cached; if not, it is generated and then saved for next time using <tt>cacheData:forPath:</tt>.  Note that this code generates a <b>file://</b> URL; I'll explain why after the code.
</p>
<hr class="seemore">


<pre>
- (void) cacheData:(NSData *)aData forPath:(NSString *)aPath;
{
    NSURL *cacheURL = [NSURL fileURLWithPath:aPath];
    NSURLResponse *response = [[[NSURLResponse alloc]
                  initWithURL:cacheURL
                     MIMEType:@"application/octet-stream"
        expectedContentLength:[aData length]
             textEncodingName:nil] autorelease];
    NSCachedURLResponse *cachedResponse = [[[NSCachedURLResponse alloc]
        initWithResponse:response data:aData] autorelease];
    NSURLRequest *request = [NSURLRequest requestWithURL:cacheURL];
    [self storeCachedResponse:cachedResponse forRequest:request];
}

- (NSData *)cachedDataForPath:(NSString *)aPath;
{
    NSURL *cacheURL = [NSURL fileURLWithPath:aPath];
    NSURLRequest *request = [NSURLRequest requestWithURL:cacheURL];
    NSCachedURLResponse *resp = [self cachedResponseForRequest:request];
    return [resp data];
}
</pre>
<p>
I discovered a couple of interesting issues in this technique.  My first cut at the code used an ad-hoc, unregistered URL scheme created with <tt>-[NSURL initWithScheme:host:path:]</tt>. The data seemed to get cached fine, but retrieving it was another matter.  If I made a new <b>NSURLRequest</b> out of the identical URL, the <b>NSCachedURLResponse</b> could not be found using <tt>-[NSURLResponse cachedResponseForRequest:]</tt>.  Perhaps this was the case because there was no <b>NSURLProtocol</b> to treat this scheme as a recognized URL type.  When I switched to a file URL scheme, <i>even if the given path does not correspond to a real file</i>, the caching and lookup worked fine.
</p>
<p>
The other issue I ran across was in disk caching.  The main reason I am caching these data is so that they are stored on disk for faster access next time I run the application.  Unfortunately, <b>NSURLCache</b> doesn't give you much control over writing to disk.  Using the shared URL cache retrieved from <tt>+[NSURLCache sharedURLCache]</tt>, the cached data appeared on disk after about 15 seconds of idle time.  Fair enough.  But when I created my own URL cache (which I want to do so that my cache can be used across applications), everything worked <i>except</i> the cache would never be saved to disk!  The cache folder would remain empty no matter what.  I don't know if that is a bug or a feature.
</p>
<p>
<b>The Next Step...</b>
</p>
<p>
This was a useful exercise, and it's nice that I'm now using Cocoa's caching mechanism.  But it feels like I'm going behind Cocoa's back by managing the cache myself, faking URL responses just to get my data cached.  So the next step I plan on taking, eventually, is to go ahead and make up my own URL scheme and let the caching system manage everything.  When I want the data, I'll construct the appropriate URL and ask for the data.  I'll put the data generation into that URL protocol.
</p>
<p>
Once I get it reworked that way, I'll be happy to report my experiences here.
</p>
<p>
<b>Update:</b> Inspired by <a href="http://inessential.com/?comments=1&amp;postid=3389">something Brent Simmons posted</a>, I figured out why I couldn't get my new cache to write to disk.  In my case, I was neglecting to call <tt>+[NSURLCache setSharedURLCache:]</tt>, which I had assumed I wouldn't need since I was calling the cache I created directly.  <i>Unfortunately, this defeats the whole purpose of having a specific cache, if it's going to be the shared cache for the entire application.  I really wanted to be able to specify that certain kinds of data go into a particular cache, but not all my application's data!  This problem has been filed with Apple as bug ID <a href="rdar://5031377">5031377</a></i>
</p></div>
	</div>
</div>
	</div> <!-- end contentCenter -->
</div> <!-- end frame -->

</body>
</html>

