<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
		<meta http-equiv="content-type" content="text/html;charset=ISO-8859-1" />
		<title>Dan Wood: The Eponymous Weblog (Archives) | by Dan Wood, Karelia Software</title>
		<meta name="description" content="Useful Tidbits and Egotistical Musings from Dan Wood, co-owner of Karelia Software. This blog mostly covers geeky topics like Mac Programming." />

<link rel="alternate" type="application/rss+xml" title="RSS" href="http://gigliwood.com/weblog/index.rss" />



<style type="text/css">

/* color palette: tinyurl.com/tgq5o */

body {
	background:#9191FF;
	margin:0;
	padding:0;
	font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size:76%;
	word-wrap:break-word;
	}


pre { word-wrap:normal !important;
		font:9px monaco;
		margin-right:-3px;
	background:white; padding: 3px; overflow:auto; }


.bio { font-size:80%; margin:auto; text-align:center; padding:10px 40px; }
.description { clear:all; color:white; font-weight:bold; font-size:120%; margin:auto; text-align:center; }

.categories { text-align:center; border-top:1px dashed #888; border-bottom:1px dashed #888; }

#frame {
	margin-left:auto;
	margin-right:auto;
	padding:0px;
	width:785px;
	overflow:auto;
	margin-bottom:80px;
	}
	
#heady {
	background:#12127D;
	color:#B37D00;
	padding:20px 10px 10px 10px;
}

#heady a:link              { color:#FFB200; text-decoration:underline; }
#heady a:visited           { color:#FFB200; text-decoration:none; }
#heady a:hover             { color:#C8C8FF; text-decoration:underline; }
#heady a:active            { color:#FFFFFF; text-decoration:underline; }

h1, h2, h3, h4 {
	margin:0;
}

h1 {
	padding-bottom:20px;
	font-weight:normal;
	font-family:Zapfino, Georgia, serif;
	text-shadow:white 0 0 20px;
	text-align:center;
}
	
#contentcenter {
	width: 565px;
	}

div.dateHeader {
	text-align:right;
	padding:5px;
	font-weight:bold;
	}

/* holds one item */
div.item {
	background:white;
	overflow:auto;
	}

/* sub-holds one item */
div.row {
  		}

div.row .label {
		float: left;
		width: 105px;
		}
		
p.postinfo {
		text-align: right;
		padding:10px 10px 5px 5px;
		font-size:70%;
		margin:0;
}
		
.label h2 {
	color:#12127D;
	font-size:140%;
	background:#ffB200;
	text-shadow:white 2 0 2px;
	padding:5px;
	margin:0;
	font-family:Georgia, serif;
	font-weight:normal;
}

.label img {
	padding:3px 0;
}

.label a:link              { color:#1919B3; text-decoration:none; }
.label a:visited           { color:#9191FF; text-decoration:none; }
.label a:hover             { color:#12127D; text-decoration:underline; }
.label a:active            { color:#B37D00; text-decoration:underline; }


div.row .value {
		float: left;
		width: 440px;
		text-align: left;
		padding:0 10px 60px 10px;
		background:#FFECBF;
		font-family:Georgia, serif;  font-size:110%;
		}

.value a:link              { color:#1919B3; text-decoration:none; }
.value a:visited           { color:#9191FF; text-decoration:none; }
.value a:hover             { color:#12127D; text-decoration:underline; }
.value a:active            { color:#B37D00; text-decoration:underline; }


#sidebar {
	background:#FFD980;
	width:200px;
	padding:20px 10px 80px 10px;
	height:100%;
	text-align:center;
	float:right;
	font-size:80%;
	}

#sidebar a:link              { color:#1919B3; font-weight:normal; text-decoration:underline; }
#sidebar a:visited           { color:#9191FF; font-weight:bold; text-decoration:none; }
#sidebar a:hover             { color:#12127D; font-weight:bold; text-decoration:underline; }
#sidebar a:active            { color:#B37D00; font-weight:bold; text-decoration:underline; }
	
div.calendar {
}
table.month-calendar {
	margin-left:auto;
	margin-right:auto;
	width:80%;
}

.month-calendar, .year-calendar {
	border-collapse:	collapse; 
}
.month-calendar-head, .year-calendar-head {
	background:		#cccccc;
	font-size:		110%;
	font-weight:		bold;
}
.month-calendar-day-head, .year-calendar-subhead {
	font-weight:		normal;
}

.month-calendar-day-noday,
.month-calendar-day-link,     .year-calendar-month-link,
.month-calendar-day-nolink,   .year-calendar-month-nolink,
.month-calendar-day-this-day, .year-calendar-this-month,
.month-calendar-day-future,   .year-calendar-month-future  {
	text-align:		center;
}

.month-calendar-day-future, .year-calendar-month-future {
	color:			#83660F;
}

.Saturday, .Sunday {
	background:		#eeeeee;
}

.month-calendar-day-this-day, .year-calendar-this-month {
	background:		#a5e4ff;
}

</style>

</head>

<body>
<div id="frame">
	<div id="heady">
		<h1>Dan Wood: The Eponymous Weblog <span style="font-size:70%;">(Archives)</span></h1>
		<p class="bio">
			<img style="float:right; margin-top:-20px; border:2px solid gray;" src="http://gigliwood.com/weblogpix/dan_wood.jpeg
" alt="Dan Wood" height="82" width="49" />
		<i>Dan Wood is co-owner of <a href="http://www.karelia.com/">Karelia Software</a>, creating programs for the Macintosh computer.  He is the father of two kids, lives in the Bay Area of California USA, and prefers bicycles to cars.  This site is his older weblog, which mostly covers geeky topics like Macs and Mac Programming.  <a href="http://gigliwood.com/blog">Go visit the current blog here.</a></i>
		</p>
		<p class="description">Useful Tidbits and Egotistical Musings from Dan Wood</p>
		<p class="categories"> <em>Categories:</em> 
		<a href="../Business/index.html">Business</a> &middot; 
		<a href="../MacOSX/index.html">Mac OS X</a> &middot; 
		<a href="index.html">Cocoa Programming</a> &middot; 
		<a href="../General/index.html">General</a> &middot; 
		<a href="../index.html"><b>All Categories</b></a>
		</p>
	</div>
	<div id="sidebar">
		<h3>Calendar</h3>
		<div class="calendar">
			<table class="month-calendar"><caption class="month-calendar-head"><a title="April 2010 (1)" href="../2010/04/index.html">&larr;</a><a title="May 2010 ()" href="../2010/05/index.html">May</a>&rarr;</caption>
<tr>
<th class="month-calendar-day-head Sunday">Sun</th>
<th class="month-calendar-day-head Monday">Mon</th>
<th class="month-calendar-day-head Tuesday">Tue</th>
<th class="month-calendar-day-head Wednesday">Wed</th>
<th class="month-calendar-day-head Thursday">Thu</th>
<th class="month-calendar-day-head Friday">Fri</th>
<th class="month-calendar-day-head Saturday">Sat</th>
</tr>
<tr>
<td class="month-calendar-day-noday Sunday">&nbsp;</td>
<td class="month-calendar-day-noday Monday">&nbsp;</td>
<td class="month-calendar-day-noday Tuesday">&nbsp;</td>
<td class="month-calendar-day-noday Wednesday">&nbsp;</td>
<td class="month-calendar-day-noday Thursday">&nbsp;</td>
<td class="month-calendar-day-noday Friday">&nbsp;</td>
<td class="month-calendar-day-nolink Saturday">1</td>
</tr>
<tr>
<td class="month-calendar-day-nolink Sunday">2</td>
<td class="month-calendar-day-nolink Monday">3</td>
<td class="month-calendar-day-nolink Tuesday">4</td>
<td class="month-calendar-day-nolink Wednesday">5</td>
<td class="month-calendar-day-nolink Thursday">6</td>
<td class="month-calendar-day-nolink Friday">7</td>
<td class="month-calendar-day-nolink Saturday">8</td>
</tr>
<tr>
<td class="month-calendar-day-nolink Sunday">9</td>
<td class="month-calendar-day-nolink Monday">10</td>
<td class="month-calendar-day-nolink Tuesday">11</td>
<td class="month-calendar-day-nolink Wednesday">12</td>
<td class="month-calendar-day-nolink Thursday">13</td>
<td class="month-calendar-day-nolink Friday">14</td>
<td class="month-calendar-day-nolink Saturday">15</td>
</tr>
<tr>
<td class="month-calendar-day-nolink Sunday">16</td>
<td class="month-calendar-day-nolink Monday">17</td>
<td class="month-calendar-day-nolink Tuesday">18</td>
<td class="month-calendar-day-nolink Wednesday">19</td>
<td class="month-calendar-day-nolink Thursday">20</td>
<td class="month-calendar-day-nolink Friday">21</td>
<td class="month-calendar-day-nolink Saturday">22</td>
</tr>
<tr>
<td class="month-calendar-day-nolink Sunday">23</td>
<td class="month-calendar-day-nolink Monday">24</td>
<td class="month-calendar-day-nolink Tuesday">25</td>
<td class="month-calendar-day-nolink Wednesday">26</td>
<td class="month-calendar-day-nolink Thursday">27</td>
<td class="month-calendar-day-nolink Friday">28</td>
<td class="month-calendar-day-nolink Saturday">29</td>
</tr>
<tr>
<td class="month-calendar-day-nolink Sunday">30</td>
<td class="month-calendar-day-this-day Monday">31</td>
<td class="month-calendar-day-noday Tuesday">&nbsp;</td>
<td class="month-calendar-day-noday Wednesday">&nbsp;</td>
<td class="month-calendar-day-noday Thursday">&nbsp;</td>
<td class="month-calendar-day-noday Friday">&nbsp;</td>
<td class="month-calendar-day-noday Saturday">&nbsp;</td>
</tr>
</table>

		</div>

		<h3><a href="http://amzn.com/w/2663V7TM8IKKC">My Amazon WishList</a></h3>


		<p>Subscribe:
		   <a href="http://gigliwood.com/weblog/index.rss" title="RSS Feed for this category; drag link into a news reader program."><img  src="http://gigliwood.com/weblogpix/rss.gif" alt="RSS" border="0" /></a>
		</p>
		<p>
				<a href="mailto: dan at this domain">Feedback</a></i>
		</p>
		
		<p>
			<b>Also on this website</b>
			<a href="http://gigliwood.com/abcd/">A Basic Course in Dvorak</a> &middot;
			<a href="http://gigliwood.com/kenwood/Pickle/">The Pickle Machine</a> &middot;
			<a href="http://gigliwood.com/mentos/">The Mentos Gallery</a> &middot;
			<a href="http://gigliwood.com/tabletester">Cocoa Table Tester</a> &middot;
			<a href="http://gigliwood.com/wedding">Making your Wedding Make a Difference</a> &middot;
			</p>
		<p>
			<b>Sites I also work on</b>
			<a href="http://www.bikealameda.org/">BikeAlameda</a> &middot;
			<a href="http://progala.blogspot.com/">A Progressive Alamedan (my political blog)</a> &middot;
			<a href="http://www.karelia.com/">Karelia Software</a>
		</p>
		
		<p>
			<b>I'm also here:</b>
			<a href="http://twitter.com/danwood">danwood</a> on Twitter
		</p>
	</div> <!-- end sidebar -->

	<div id="contentcenter">





<div class="dateHeader">Fri, 08 Jan 2010</div>
<div class="item">
	<div class="row">
		<div class="label">
			<h2>Converting Rich Text to TEXT/styl resources for an SLA on a Disk Image</h2>
			<p class="postinfo">
				<a href="Converting_Rich_Tex.html">permanent link</a>
				&middot; Topic<a href="../Cocoa/">/Cocoa</a>
				<br />
				<a href="../Cocoa/"><img border="0" src="http://gigliwood.com/weblogpix/Cocoa.gif" alt="/Cocoa" /></a>
				
			</p>
		</div>
		<div class="value"><p><i><b>Update:</b> <a href="http://brockerhoff.net/">Rainer Brockerhoff</a> told me that you can actually put an 'RTF ' resource in the resource file, rather than TEXT/styl, so it turns out that this is not the easiest solution.</i>
</p>

<p>
One thing that I try to accomplish each January is to update our copyright statements in all the right places. The only straggler that remained was the Software License Agreement that is embedded in our disk images.
</p>
<p>
Unfortunately, the text for this is not stored in any way that makes it easy to update things. The rich text is stored as an old-fashioned Circa 1984 resource fork, as TEXT and styl resources. (Apple's "Software License Agreements for UDIFs" SDK <a href="ftp://ftp.apple.com/developer/Development_Kits/SLAs_for_UDIFs_1.0.dmg">[Download DMG]</a> has all the gory details.)
</p>
<p>
It's barely possible to even edit a resource file nowadays.  There is the open-source <a href="http://resknife.sourceforge.net/">ResKnife</a> but it doesn't seem to have TEXT/styl support.  There's <a href="http://www.ljug.com/sw/resfool.html">ResFool</a>, but at least as of this writing the website isn't even loading.  There are of course options like ResEdit and Resorcerer that one can run under Classic mode from older versions of Mac OS X, but that's not particularly convenient!
</p>
<p>
I really was hoping I could just store our SLA text as rich text (like .rtf files) and have the conversion to the resources handled for me automagically!
</p>
<p>
No wonder many developers use tools like <a href="http://c-command.com/dropdmg/">DropDMG</a> and <a href="http://www.araelium.com/dmgcanvas/">DMGCanvas</a>. The trouble is, we have all of our build/package/upload process as a shell script, run from a build phase on Xcode. So I really needed a scriptable tool to produce the correct resources.
</p>
<p>
I did some digging, and I found a nice hint (at the bottom of <a href="http://www.cocoadev.com/index.pl?ExtractstylResourceFromNSAttributedString">this page</a>) for converting rich text to TEXT/styl resources by using NSPasteboard.  
</p>
<p>
So I whipped up some code that goes something like this.  
</p>

<pre>
int main (int argc, const char * argv[])
{
    NSAutoreleasePool * pool = [[NSAutoreleasePool alloc] init];

	if (2 != argc)
	{
		NSLog(@"Usage: %@ srcpath\n", [[NSString stringWithUTF8String:argv[0]] lastPathComponent]);
		return -1;
	}

	NSString *sourcePath = [NSString stringWithUTF8String:argv[1]];
	NSAttributedString *str = [[NSAttributedString alloc] initWithPath:sourcePath documentAttributes:nil];
	NSData *data = [str RTFFromRange:NSMakeRange(0, [str length]) documentAttributes:nil];

	NSPasteboard *pb = [NSPasteboard generalPasteboard];
	[pb declareTypes:[NSArray arrayWithObject:NSRTFPboardType] owner:nil];
	[pb setData:data forType:NSRTFPboardType];

	NSData *textData  = [pb dataForType:@"CorePasteboardFlavorType 0x54455854"];   // TEXT
	NSData *styleData = [pb dataForType:@"CorePasteboardFlavorType 0x7374796C"];   // styl
</pre>

<p>
All I needed to do was to write the NSData to a ".r" file. I found a bit of code via Google, from an app called 
<a href="http://shigematsu.org/index.php?JPEGBatcherX">JPEGBatcherX</a>.  It looks like the author was doing something similar.  I adapted his <tt>dump_rsrc</tt> method from this source file which was directly indexed by Google: <a href="http://shigematsu.org/index.php?plugin=attach&amp;openfile=rtf2r.m&amp;refer=JPEGBatcherX%2FDevelopment"> rtf2r.m</a>.   (I don't want to reproduce the code here because it's not clear what the copyright on the code is.)
</p>
<p>
So the above function should be able to end like this:
</p>
<pre>
	dump_rsrc("TEXT", textData);
	dump_rsrc("styl", styleData);

	[pool drain];
    return 0;
}
</pre>

<p>
However, I hit a snag. When running on my Intel Mac, this is an invalid 'styl' resource.  I had to dig up an old copy of Resorcerer and run it under Classic on my old G5 to figure out why.
</p>
<p>
A valid 'styl' resource starts something like this:
</p>
<p>
<tt>0060 0000 0000 000F 000C 0400 0100 000C</tt>
</p>
<p>
This corresponds to: 0x0060 style runs, 0x00000000 first offset, 0x000F line height, 0x000C font ascent, 0x0400 font family, 0x0100 char style, 0x000c pixel size, and so forth.
</p>
<p>
However, the style data I was getting from the pasteboard was more like this:
</p>
<p>
<tt>6000 0000 0000 0f00 0C00 0004 0001 0C00</tt>
</p>
<p>
It sure looks like a little-endian <i>vs.</i> big-endian issue.  This perplexed me, considering I was not manipulating numbers; I was just asking the pasteboard for a bit of data that I ought to be able to write into the 'styl' resource.
</p>
<p>
Fortunately Daniel Jalkut <a href="http://twitter.com/danielpunkass/status/7532594215">mentioned</a> some methods that were designed to flip resource data around.  He later <a href="http://twitter.com/danielpunkass/status/7533163887">explained</a> "Apple provided flippers for many common resource types, but left us to our own devices for some of the less common/modern ones."
</p>
<p>
I guess this make a small amount of sense.  Rather than Apple rewriting the resource manager code to deal with endian issues, we just flip the data afterwards. Still, it's a bit tricky if you don't expect that!
</p>
<p>
So all I needed was to copy the bytes to a writeable block and call the appropriate routine to flip them around. Note my <tt>#ifdef</tt> in the code so that in case the code is big-endian, no real flipping will happen.
</p>

<pre>
	int len = [styleData length];
	char *bytes = malloc(len);
	[styleData getBytes:bytes length:len];

	OSStatus status = CoreEndianFlipData (
	  kCoreEndianResourceManagerDomain, //OSType dataDomain,
	  'styl', //OSType dataType,
	  0, //SInt16 id,
	  bytes, //void *data,
	  len, //ByteCount dataLen,
#ifdef __BIG_ENDIAN__
	  true
#else
	  false	//Boolean currentlyNative
#endif
	  );

	NSData *newStyleData = [[[NSData alloc] initWithBytesNoCopy:bytes length:len freeWhenDone:YES] autorelease];
</pre>

<p>
That does the trick! Now all I have to do is to concatenate the TEXT/styl resources produced with this tool to with the other (un-changing) resources I'm storing in a common ".r" file and build them into my disk image, using the 'Rez' tool.
</p>
</div>
	</div>
</div>
<div class="dateHeader">Sat, 30 Aug 2008</div>
<div class="item">
	<div class="row">
		<div class="label">
			<h2>Clang's Empirical Demonstration of a Need for Defensive Coding Guidelines</h2>
			<p class="postinfo">
				<a href="Clang_s_Empirical_D.html">permanent link</a>
				&middot; Topic<a href="../Cocoa/">/Cocoa</a>
				<br />
				<a href="../Cocoa/"><img border="0" src="http://gigliwood.com/weblogpix/Cocoa.gif" alt="/Cocoa" /></a>
				
			</p>
		</div>
		<div class="value"><p>
At the job that I had before starting Karelia Software, around the turn of the century, our software engineering department had a fairly intense set of coding guidelines.  Not just the formatting rules that people had to follow (e.g. no K&amp;R braces, indentation rules, etc.) but also many guidelines that were about programming <i>defensively</i>.  The idea was that you had to write code that was less likely to have errors in it, and was less likely to have errors introduced later on.
</p>
<p>
Although the guidelines were originally written for C++ (for old-school Mac development), a lot of the rules transferred easily to Java (as did the many of the developers!), and then, with me, when I went "indie," to Objective-C.
</p>
<p>
I don't have a copy of that document, alas, but I did manage to internalize many of those rules, so that it became habit for me (for the most part), and I've been able to add on to some of those rules to be specific to Objective-C/Cocoa programming.
</p>
<p>
A few days ago, I found out about the <a href="http://clang.llvm.org/StaticAnalysis.html"> LLVM/Clang Static Analyzer</a> &mdash; "Clang" for short &mdash; from a number of developers on <a href="http://twitter.com/">Twitter</a> (where I am "danwood", BTW, and a lot more active there than on this blog these days).  I ran our codebase (Sandvox, along with the iMedia Browser and other bits of code) through the analyzer, and what I found was very interesting: <b>Most of the bugs that it found, if we had better applied the guidelines we've been <i>trying</i> to follow, would not have been there</b>.  I consider this proof of the utility of these kinds of guidelines, which I'll list later on here.
</p>
<p><a href="Clang_s_Empirical_D.html" class="seemore">See more ...</a></p>

</div>
	</div>
</div>
<div class="item">
	<div class="row">
		<div class="label">
			<h2>Help! with some mystery backtraces, or, Airing our Dirty Laundry</h2>
			<p class="postinfo">
				<a href="Help!_with_some_mys.html">permanent link</a>
				&middot; Topic<a href="../Cocoa/">/Cocoa</a>
				<br />
				<a href="../Cocoa/"><img border="0" src="http://gigliwood.com/weblogpix/Cocoa.gif" alt="/Cocoa" /></a>
				
			</p>
		</div>
		<div class="value"><blockquote>
I make my living off the evening news<br />
Just give me something-something I can use<br />
People love it when you lose,<br />
They love dirty laundry<br />
<em>&mdash; Don Henley, "Dirty Laundry"</em>
</blockquote>
<p>
So we are close to releasing Sandvox 1.5 over in <a href="http://www.karelia.com/">Karelia</a>-land.  But there are a few exceptions and crashes that people are getting, and we're out of ideas on how to diagnose them. (Of course, they don't happen to us!)
</p>
<p>
So <a href="http://twitter.com/thekarladam/statuses/903782028">Karl suggested</a> posting the backtraces and seeing if any of our astute readers (of the Developer persuasion) had some ideas.  Can those of you not daunted by this prospect take a look and see if anything comes to mind, any thoughts that you might have to help track down the issues at hand?  I have some good juicy backtraces with symbols, the trick is figuring out why these crashes or exceptions happened.  (For the crashes I am just including the backtraces but I could upload the full crash reports if people want...)  
</p>
<p>
I'd love to hear your comments in the comments section, or you can drop me a line: dwood at the venerable domain of karelia, in the kingdom of Dot Com.
</p>
<p><a href="Help!_with_some_mys.html" class="seemore">See more ...</a></p>

</div>
	</div>
</div>
<div class="dateHeader">Mon, 04 Aug 2008</div>
<div class="item">
	<div class="row">
		<div class="label">
			<h2>A Great Need for Better Localization Solutions for Mac Developers
</h2>
			<p class="postinfo">
				<a href="A_Great_Need_for_Be.html">permanent link</a>
				&middot; Topic<a href="../Cocoa/">/Cocoa</a>
				<br />
				<a href="../Cocoa/"><img border="0" src="http://gigliwood.com/weblogpix/Cocoa.gif" alt="/Cocoa" /></a>
				
			</p>
		</div>
		<div class="value"><p>
I've been spending the last few days, on and off, dealing with localizations of the new <a href="http://www.sandvox.com/">Sandvox</a> version we are trying to get ready.  Each time we have a new version coming out, I have to go through a lot of tedium and hassle to successfully get Sandvox updated and fully functional in several languages.  It really could be a <em>lot</em> easier than it is now.</p>
<p>
<img src="http://docs.karelia.com/z/img/thumb/f/f1/I18n.jpg/256px-I18n.jpg" style="float:right; margin:0 0 1em 1em;" />
The current version of Sandvox has eight localizations. Besides English, it's in Danish, French, German, Italian, Japanese, Traditional Chinese (Taiwan) and Simplified Chinese (China). The localizations are done by some wonderful, amazing volunteers.  (We may have to drop a couple of supported localizations for our forthcoming 1.5 version; we've lost a couple of our volunteers unfortunately.)  The volunteers all use <a href="http://www.arizona-software.ch/ilocalize/">iLocalize</a>, which is a great (but by no means the only) localization tool out there; if they don't have the program we get them a license for them to use it.</p>
<p>
The ideal workflow goes something like this:  When we are getting near a release, we send a private build of Sandvox out to these localizers.  They each open the application bundle with iLocalize, and it figures out what strings need to be translated, keeping track of the strings that have already been translated.  When they are done, they export the resources (.strings files, .nib files, and a few .html files) and email them back to us.  Using a shell script, I copy the resources into a new directory structure that parallels our subversion repositories (since the topology of an application package is not the same as our source code).  Another script copies the files into the corresponding places in our subversion repository, careful not to stomp on the .svn directories.</p>
<p>
In an ideal world, that would be pretty easy.  The problem is, a release is a moving target.  Even though we declared we were "frozen" for strings about a month ago, little things crop up -- a bugfix may change a string or require a new error message.  Or last-minute changes, like the debut of MobileMe, mean that we have to go through another round of localization.  And frustratingly, we find that even after we have accepted a localization, merged it into our source repository, and built a new version, that new version isn't <em>quite</em> fully localized.  Somehow, some strings got missed.</p>
<p>
The worst problem in all this is nib files.  Once we have localizations in play, a change to a nib (adding or repositioning a label, hooking up a forgotten outlet or action or binding, etc.) has to be propagated to all the localizations, or there will be a bug in your program when it's running under other languages.  This means that the programmer has to go through and make the same change <i>n</i> times, or rely on the translator to know that they have to <em>rebuild</em> the translated nib from the English (source) version.  (I'll assume that English is your source language for the rest of this article.)</p>
<p>
It's very difficult to make sure that all our languages are really working when maintaining multiple nib files is so fragile.  </p>
<p>
".strings" files, though they are a lot simpler and just text files, are not without their problems as well.  If you fix a typo in your English text,  you have to make sure to fix that source string in all of your translated .strings files, or your source will not be found and show up as English in your otherwise translated program.  You are not likely to know that there is a problem unless you can test every message your program will ever encounter in all its translations.  (Peter Hosey's <a href="http://boredzo.org/localization-helper/">Localization Helper</a> is a utility that can help with this a bit, though.)</p>
<p>
The problems of dealing with translations are so great that several developers have abandoned localized nibs completely &mdash;&#160;<a href="http://www.cocoatech.com/">CocoaTech</a> has done this for <em>Path Finder</em>, as has <a href="http://www.delicious-monster.com/">Delicious Monster</a> for <em>Delicious Library</em>.  I'm sure there are others. The alternate approach is to have a single nib, putting in translated strings on-the-fly, and possibly resizing the views programatically to make the elements fit.  (Languages such as French and German take up quite a bit more space than English!)</p>
<p>
On-the-fly localization is a decent idea &mdash; we're considering it for our next major version of Sandvox to alleviate  some of these hassles &mdash;&#160;but it's not without its drawbacks.  You really have to prepare your nibs for the "worst case" scenario of elements fitting.  There are some scenarios in Sandvox that I'm not sure how we could work around: for instance, some labels are so long in their translation that we have to split them into two or three lines to fit.  This affects the horizontal positioning of everything else.  If we left room for the eventual translation,  then the English version would look strange.  When you are aligning elements with each other (for instance, right-justifying several labels to the left of some checkboxes), you would need to move all the items that were aligned.  Or, you just leave a lot of blank space in the English version &mdash;&#160;a feat that sounds like a good idea but is hard to accomplish in small elements such as inspector windows.</p>
<p>
<b>Solutions?</b></p>
<p>
It seems that Apple needs to take Internationalization ("i18n" for those who don't want to type a twenty-letter word) a lot more seriously and integrate this directly into Interface Builder and Xcode.</p>
<p>
Xcode is slightly aware of localized files, and Interface Builder and Xcode are slightly aware of each other, so I don't see why there couldn't be more direct i18n support built in.</p>
<p>
Imagine if your localized files were just always synced with their original counterparts.  If I adjusted a string in my Objective C file, the English .strings file could be automatically updated, and so would the translated versions (with a warning marking to indicate that somebody will need to check the translations.)  If I deleted an English string, the corresponding localizations would be deleted too, since they wouldn't be needed.  If I added a new string, the translated files would have entries for those new strings, marked as needing to be translated.</p>
<p>
If I modified a nib, I'd only have to deal with the English nib.  I could add a connection or binding, fix the spelling of an action's method name, etc. and not have to worry about the translated nibs getting out of sync.  If I added or changed the contents of a textual label, then the translated nib files could be marked as needing to be translated or checked.  If I deleted something, they would be gone in the translated nib.  If I moved or resized something, the translated nibs might indicate a warning if the corresponding string is conflicting with something.</p>
<p>
(I'm always finding that it's very difficult to see when a string has not been given enough room in a translation, and we're forever getting complaints that buttons in German are truncated.  Not surprising, considering I don't speak the language and thus I can't tell at a glance if the text has been truncated!  There needs to be big bold warnings that text is getting truncated in your nibs!)</p>
<p>
Perhaps what is needed is an overhaul of the way that nibs are stored.  Yes, i know that the .xib format in Leopard is new, but couldn't nib files be split into connections (one per nib, period), strings (one per localization), and layout (one per localization if needed), so that it's impossible to get the kinds of inconsistencies that we developers are always fighting?</p>
<p>
Maybe we need more ways to lay out items in a nib so that automatic repositioning is easier, so you can avoid a lot of the headaches of multiple layouts to check.  In the simple cases where a button is the only element on a "line" and you make the text wider, that's a no-brainer.  But when you start dealing with groups of items side by side that need to align with each other, I don't think that there is enough information in the struts-and-springs model we use now to automatically "stretch" things appropriately  to fit different languages automatically.</p>
<p>
What do you think?  Are there any tricks to localization that I haven't covered here?  </p>
<p>
If you agree that Apple needs to make localization easier and more integrated, please <a href="https://bugreport.apple.com/">file a new bug</a> and say "me too" to <b>radar ID <a href="rdar://6078830">6078830</a></b> ...
</p></div>
	</div>
</div>
<div class="dateHeader">Wed, 23 Jul 2008</div>
<div class="item">
	<div class="row">
		<div class="label">
			<h2>Apple, it's time to lift the iPhone development NDA.</h2>
			<p class="postinfo">
				<a href="Apple,_it_s_time_to.html">permanent link</a>
				&middot; Topic<a href="../Cocoa/">/Cocoa</a>
				<br />
				<a href="../Cocoa/"><img border="0" src="http://gigliwood.com/weblogpix/Cocoa.gif" alt="/Cocoa" /></a>
				
			</p>
		</div>
		<div class="value"><p>
The reason that the Mac developer community is thriving so much is the exchange of information among developers to help fill in the gaps in documentation and understanding of the details. Most Mac applications have been developed because of the open access to information about development and the ability to share that information. I can understand the iPhone SDK being under Non-Disclosure Agreement (NDA) before the release of 2.0, but to continue the silence is making things very bad. It's preventing conferences, classes, books, and tutorials from happening. Is there *anything* good about the NDA continuing? I think not.
</p>
<p>I am ready to dive into iPhone development &mdash; we have not quite yet take the plunge &mdash;&#160;but if an NDA continues, I may just sit this one out.
</p>
<p>
Here is an interesting idea: Gather petitions showing the strong desire for the iPhone SDK to be open so that developers can discuss things.  This isn't just for developers to sign!  If you are an iPhone user, you are only going to benefit in the quality of the iPhone applications available if Apple lifts the NDA.  If they don't, your applications are not going to be as good.
</p>
<p>So <a href="http://www.ipetitions.com/petition/iPhoneNDA/">Please sign the petition here.</a></div>
	</div>
</div>
<div class="item">
	<div class="row">
		<div class="label">
			<h2>Indie Fever</h2>
			<p class="postinfo">
				<a href="Indie_Fever.html">permanent link</a>
				&middot; Topic<a href="../Cocoa/">/Cocoa</a>
				<br />
				<a href="../Cocoa/"><img border="0" src="http://gigliwood.com/weblogpix/Cocoa.gif" alt="/Cocoa" /></a>
				
			</p>
		</div>
		<div class="value"><p>Yesterday, Michiel van Meeteren released <a href="http://www.madebysofa.com/indiefever/">Indie Fever</a>, his thesis about the "Indie" Mac developer culture.  It's over 100 pages, and a bit technical &mdash; his field's terminology, not ours, though!  But it was certainly an interesting read, and I recommend it for current or future indie Mac developers.</p>
<p>
One thing that struck me was the notion that we members of the development community are competitors: "Despite these collaborations they still regard each 
other as competitors although all sorts of unspoken rules apply to the kind of 
competition that is allowed within the community."</p>
<p>
Yes, there are some competitors in this community, meaning that their products overlap in functionality enough to attract potentially the same customer base.  But most of the people I interact with in the developer community are not competitors at all, unless you really stretch the definition by saying that we are competing for the attention and hard-earned dollars of the Mac users out there.  Miciel compares the nature of the community to "the close-knit craft communities of Northern Italy or the diamond merchants of Antwerp."  I don't know if that's quite accurate, if they are all selling the same things.</p>
<p>
To choose a fun metaphor, we're the vendors at an electronic farmer's market.  
I might be selling peaches, but the vendors around me are selling honey, vegetables, flowers, and jars of curry.  I'm not going to have any poroblems with the guy who's selling zucchini in the booth next door; in fact we're probably going to be buddies and help each other out.  </p>
<p>
And if there are enough people mulling around the market, I'm probably not going to mind the other guy selling peaches across the aisle (unless he's, say, giving them away for free; I'd need to make sure my peaches were better than his).</p>
<p>
You see, there are something like 20 million users of current (Tiger or Leopard) Macs out there.  Sure, it's less than the numbers of Windows PCs out there, but who cares.  This is a large potential customer base.  We indies, in order to make a living, really only need to make customers out of a very small fraction of the Mac users out there.  An indie developer needs only a few thousand customers to make a living; we're talking only about <i>one one-thousandth</i> of the current Macs out there.</p>
<p>
Since there are plenty of potential users of our software to go around, I like the idea of each other helping each other out.  We've had a <a href="http://www.karelia.com/good_karma_repository/">Good Karma</a> section on our website and in our periodic email alert blasts, where we highlight some of our favorite indie apps.  This is one of our ways of being part of the developer community.</p>
<p>
I may have some more thoughts about the developer community and the business of being an Indie in subsequent posts.  Stay tuned.
</p>
</div>
	</div>
</div>
<div class="dateHeader">Thu, 01 May 2008</div>
<div class="item">
	<div class="row">
		<div class="label">
			<h2>An easy way to manage singleton window controllers</h2>
			<p class="postinfo">
				<a href="An_easy_way_to_mana.html">permanent link</a>
				&middot; Topic<a href="../Cocoa/">/Cocoa</a>
				<br />
				<a href="../Cocoa/"><img border="0" src="http://gigliwood.com/weblogpix/Cocoa.gif" alt="/Cocoa" /></a>
				
			</p>
		</div>
		<div class="value"><p>
In <a href="http://www.sandvox.com/">Sandvox</a> and <a href="http://www.karelia.com/imedia/">iMedia Browser</a>, we use a number of utility windows that are singletons; there will be only one of any of them open.  Examples include the registration window, email list signup dialog, problem reporter window, and the release notes window.
</p>
<p>
I had noticed a lot of redundant code in each of these controllers' classes dealing with maintaining the single instance of that window, which we would store in a static variable and access with a lazy accessor, not unlike the technique <a href="http://developer.apple.com/documentation/Cocoa/Conceptual/LoadingCode/Tasks/Componentizing.html#//apple_ref/doc/uid/20001275-99902">here</a>.
</p>
<p>
When something starts to get repetitive, it's time to find a better way. So I created a class <tt>KSSingletonWindowController</tt> which manages the singleton instances. Instead of storing each instance of a window controller in its own static variable, it maintains a static reference to an <tt>NSMutableDictionary</tt> holding the window controllers, keyed by an identifier (generally the subclass name).
</p>
<p>
The class contains four class methods:
</p>
<pre>
@interface KSSingletonWindowController :  NSWindowController

+ (id)sharedController;
+ (id)sharedControllerWithoutLoading;
+ (id)sharedControllerNamed:(NSString *)registrationName;
+ (id)sharedControllerWithoutLoadingNamed:(NSString *)registrationName;

@end
</pre>
<p>To access a window controller, you only need to invoke <tt>sharedController</tt> on your subclass of <tt>KSSingletonWindowController</tt>. The object will be created if it is not yet registered, and then that single object will be returned to you.  If you want to get the instance but only if it has already been loaded (useful, for instance, in clean-up code or a response to a method to close a window; there's no point creating it if it hasn't already been created) you can use <tt>sharedControllerWithoutLoading</tt>.
</p>
<p>
If you need to have more than instance of a class, you would need to register each one with a different name.  For example, you might have one instance of RTFDWindowController which you use to show release notes, and another one for showing credits. You would use the methods <tt>sharedControllerNamed:</tt> and <tt>sharedControllerWithoutLoadingNamed:</tt>, passing in arbitrary strings to identify each unique instance.
</p>
<p>
Here is the implementation.  Each method builds upon the previous ones.
</p>
<pre>
static NSMutableDictionary *sControllerRegistry = nil;

@implementation KSSingletonWindowController
</pre>
<blockquote>
<tt>sharedControllerWithoutLoadingNamed:</tt> lazily instantiates the controller registry and looks up the entry for the given key.
</blockquote>
<pre>
+ (id)sharedControllerWithoutLoadingNamed:(NSString *)registrationName
{
  if (!sControllerRegistry)
  {
    sControllerRegistry = [[NSMutableDictionary alloc] init];
  }
  KSSingletonWindowController *result
    = [sControllerRegistry objectForKey:registrationName];
  return result;
}
</pre>
<blockquote>
<tt>sharedControllerNamed:</tt> looks up the named item.  It creates and stores the object if it wasn't allocated yet.
</blockquote>
<pre>
+ (id)sharedControllerNamed:(NSString *)registrationName
{
  KSSingletonWindowController *result
    = [self sharedControllerWithoutLoadingNamed:registrationName];
  if (!result)
  {
    result = [[[self alloc] init] autorelease];
    [sControllerRegistry setObject:result forKey:registrationName];
  }
  return result;
}
</pre>
<blockquote>
<tt>sharedController</tt> and <tt> sharedControllerWithoutLoading</tt> call their "named" counterparts using the name of the class as the key.  (Obviously, you would invoke <tt>+[<i>YourClass</i> sharedController]</tt>, not <tt>+[KSSingletonWindowController sharedController]</tt> for this to work.)
</blockquote>
<pre>
+ (id)sharedController;
{
  NSString *className = NSStringFromClass(self);
  return [self sharedControllerNamed:className];
}

+ (id)sharedControllerWithoutLoading;
{
  NSString *className = NSStringFromClass(self);
  return [self sharedControllerWithoutLoadingNamed:className];
}
</pre>
<p>
That should do it!  Please feel free to use and adapt this for your projects. Enjoy!
</p>
</div>
	</div>
</div>
<div class="item">
	<div class="row">
		<div class="label">
			<h2>A Cool Way to Integrate Web and Desktop</h2>
			<p class="postinfo">
				<a href="A_Cool_Way_to_Integ.html">permanent link</a>
				&middot; Topic<a href="../Cocoa/">/Cocoa</a>
				<br />
				<a href="../Cocoa/"><img border="0" src="http://gigliwood.com/weblogpix/Cocoa.gif" alt="/Cocoa" /></a>
				
			</p>
		</div>
		<div class="value"><p>
Following the example of <a href="http://www.panic.com/">Panic</a> and others, we've put some code into our applicatons that, upon first launch, will ask people if they want to join our email announcement list.
</p>
<p>
One thing I don't like is when computers are dumb.  And what I thought would seem dumb would be the case where you are <i>already</i> on our email list, and you hear about our new app, so you download it from the link we provide, and upon launching said app, it asks you if you want to join the email list.  Well, duh!
</p>
<p>
So I mulled this over in the back of my head for a long time. Should we have a special version of our application that skips this question? Wow that would be a lot of hassle and be potentially confusing. Or would there be some way we could use AppleScript to set the user defaults for our application so that it wouldn't ask?  That would probably be pretty invasive and require the user running a script in ScriptEditor.  Or download a helper application that sets the stage in advance, then launches the real application?  Geez, that's not going to be obvious.  There must be a better way....
</p>
<p>
Somewhere along the way, it occurred to me: <i>Cookies</i>.  Yeah, that's it.  We can access the cookie store from Cocoa; it's the same cookie store used by Safari or other Webkit-based browsers. True, some Mac users are using Firefox or Camino, but this might solve it for a good chunk of users.
</p>
<p>
So what I did was to store a cookie associated with our website onn the page that a person goes to when they have confirmed that they want to sign up for our mailing list.  I also set that same cookie when somebody clicks on the download link in our email blast; the link takes them to a page that sets the cookie and starts downloading the desired file.
</p>
<p>
Our application, upon launching, first checks the user default that will be set to prevent being asked more than once. If that has not been set yet, it checks the cookie store.  If the cookie indicating that the they are on our email list is present, then they will be spared the redundant question. Only if the default and the cookie are absent will they be bothered.
</p>
<p>
The cool thing is that this cookie works across multiple applications.  The cookie check is built into <a href="http://www.karelia.com/imedia">iMedia Browser 1.1</a>, which we just released this morning, but we will be building it into Sandvox as well. Once that cookie is set, they won't be asked again from any of our applications.  Well, at least until the cookie expires &mdash;&#160;but by then they will have stored the user default to prevent being asked.
</p>
<p>
Clearly, this is not a fool-proof technique.  The cookie store might not have been written to disk by the time somebody launches the application.  The user might have cleared out their cookies, or isn't using a Webkit-based browser.  But it's an interesting, light-weight mechanism for "communicating" between Browser and Desktop.
</p>
<p>
Naturally the next thing to think about is "What else could you accomplish with this technique?"  You could set cookies on your company's website that your desktop application might be able to take advantage of, e.g. your most recent login ID (but not password of course), recently visited pages, and so forth.  The "communication" could go the other way as well; a desktop application might set some cookies that help give the corresponding website some hints for web content.
</p>
<p>
This is a very "weak" form of communication.  If you want to literally control your Desktop application from a website, you could put in hyperlinks to custom URLs that your application can respond to by implementing <a href="http://www.cocoadev.com/index.pl?HowToRegisterURLHandler">this kind of code</a>.  (For instance, <a href="imedia://reply/n=29447&s=sample+feedback&d=I+clicked+on+the+link+from+the+web+page">this link</a>, if you already have been running iMedia Browser, will open up the application's feedback window with some pre-populated fields; we've set this up to help people follow up on tech support issues.)  And of course from your desktop application you can open up arbitrary URLs in your browser using <tt>NSWorkspace</tt> operations.
</p>
<p>
But when you want non-obtrusive passing of interesting data or settings between desktop and browser, this may be a useful technique.
</p></div>
	</div>
</div>
<div class="item">
	<div class="row">
		<div class="label">
			<h2>Self-Registering Transformers</h2>
			<p class="postinfo">
				<a href="Self-Registering_Tr.html">permanent link</a>
				&middot; Topic<a href="../Cocoa/">/Cocoa</a>
				<br />
				<a href="../Cocoa/"><img border="0" src="http://gigliwood.com/weblogpix/Cocoa.gif" alt="/Cocoa" /></a>
				
			</p>
		</div>
		<div class="value"><p>
Here is a snippet of code you can put into any subclass of <tt>NSValueTransformer</tt> that will cause it to automatically register itself when the class is loaded. This is useful for almost all value transformers, except perhaps those that you need to be given a parameter in the initialization process, such as <a href="http://lists.apple.com/archives/Cocoa-dev/2004/Jun/msg01762.html">these cool transformer classes</a>.
</p>
<p>This code will just cause the transformer to be registered with the name of the class itself. So if you class was, for instance, <tt>CondenseTransformer</tt> then you would specify "CondenseTransformer" in your nib file.
</p>
<pre>
+ (void)load
{
  NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
  NSValueTransformer *theTransformer = [[[self alloc] init] autorelease];
  [NSValueTransformer setValueTransformer:theTransformer
         forName:NSStringFromClass([self class])];
  [pool release];
}
</pre></div>
	</div>
</div>
<div class="dateHeader">Mon, 21 Apr 2008</div>
<div class="item">
	<div class="row">
		<div class="label">
			<h2>Developers need to get Spin Dumps as well as Crash Dumps</h2>
			<p class="postinfo">
				<a href="Developers_need_to_.html">permanent link</a>
				&middot; Topic<a href="../Cocoa/">/Cocoa</a>
				<br />
				<a href="../Cocoa/"><img border="0" src="http://gigliwood.com/weblogpix/Cocoa.gif" alt="/Cocoa" /></a>
				
			</p>
		</div>
		<div class="value"><p>
Users of Leopard may have noticed that if you have to force-quit an application, you are prompted to submit a report to Apple, not unlike the crash reporting mechanism we are all used to.
</p>
<p>
As a developer, it occurred to me that this information would be very useful for me (and third-party developers in general) as well.
</p>
<p>I did some investigating, and found that these reports are stored in a subfolder of <tt>Library/Logs/HangReporter/</tt>.  (<span style="font-size:150%;">&#9731;</span>, it turns out, did some <a href="http://earthlingsoft.net/ssp/blog/2007/12/x5_hang_reporter">analysis</a> of this folder a while back.  Incidentally, it looks like the problem of the UNKNOWN folders has been fixed.)
</p>
<p>
Unfortunately, this directory, and the subdirectories for each application's reports, are root-only.  I'm supposing that Apple put in this protection so that applications couldn't tell what other applications were doing, but the problem is that there is no way for the third-party application to reasonably look to determine if there is a new spin report that needs submitting.  I don't think a user is going to tolerate being asked for an admin password every time they launch an application, just so the application can check to see if there are any new reports!
</p>
<p>
It would be much more useful if application-specific spin reports could be put into a user's home directory, and made readable to that user.  Then, third-party developers could cobble together a mechanism for reporting a hang, just like many of us do for crash reports.
<p>
Saving spin reports is a really cool new feature in Leopard, but if there is no way to help the third-party developer, it's just a potential feature.
</p>
<p>
Filed as <a href="rdar://5879393">rdar://5879393</a>.
</p>
</div>
	</div>
</div>
<div class="dateHeader">Mon, 10 Mar 2008</div>
<div class="item">
	<div class="row">
		<div class="label">
			<h2>CoreTypes graphics</h2>
			<p class="postinfo">
				<a href="CoreTypes_graphics.html">permanent link</a>
				&middot; Topic<a href="../Cocoa/">/Cocoa</a>
				<br />
				<a href="../Cocoa/"><img border="0" src="http://gigliwood.com/weblogpix/Cocoa.gif" alt="/Cocoa" /></a>
				
			</p>
		</div>
		<div class="value"><p>
If you are programming to target Leopard, a lot of common graphics can be found using <tt>-[NSImage imageNamed:]</tt>.  Not every generic graphic can be found there; there are a lot of images in <a href="file://localhost/System/Library/CoreServices/CoreTypes.bundle/Contents/Resources/">/System/Library/CoreServices/CoreTypes.bundle/Contents/Resources/</a>.
</p>
<p>
<img src="http://gigliwood.com/weblogpix/coretypes.png" alt="Example quicklook of coretypes" />
</p>
<p>
It's certainly worth exploring the contents of this folder and possibly making use of the images. But since these images are not documented as an API, you will need to be sensitive to whether or not these images are still part of upcoming &mdash; or legacy &mdash; versions of Mac OS.
</p>
<p>
Since Sandvox is targetting either Tiger or Leopard, we have to be careful not to make use of a graphic that is in one big cat and not the other.
</p>
<p>
For our convenience, and for yours, I created a "diff" showing the contents of the Tiger <i>vs.</i> Leopard contents of the graphic files in that folder, after the break.
</p>
<p><a href="CoreTypes_graphics.html" class="seemore">See more ...</a></p>

</div>
	</div>
</div>
<div class="dateHeader">Wed, 27 Feb 2008</div>
<div class="item">
	<div class="row">
		<div class="label">
			<h2>KSExtensibleManagedObject</h2>
			<p class="postinfo">
				<a href="KSExtensibleManaged.html">permanent link</a>
				&middot; Topic<a href="../Cocoa/">/Cocoa</a>
				<br />
				<a href="../Cocoa/"><img border="0" src="http://gigliwood.com/weblogpix/Cocoa.gif" alt="/Cocoa" /></a>
				
			</p>
		</div>
		<div class="value"><p>
We at <a href="http://www.karelia.com/">Karelia</a> have been recently going through a bunch of our source code, pulling out the general-purpose stuff apart from the Sandvox-specific stuff.  Some of this is worth sharing.
</p>
<p>
Fellow Karelian <a href="http://mikeabdullah.net/">Mike Abdullah</a> has written a nice class that extends Core Data in a nice way.  It's called KSExtensibleManagedObject.  <a href="http://mikeabdullah.net/ksextensiblemanagedobject.html">Check it out</a>.
</p>
</div>
	</div>
</div>
	</div> <!-- end contentCenter -->
</div> <!-- end frame -->

</body>
</html>

