<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
		<meta http-equiv="content-type" content="text/html;charset=ISO-8859-1" />
		<title>Dan Wood: The Eponymous Weblog (Archives) | by Dan Wood, Karelia Software</title>
		<meta name="description" content="Useful Tidbits and Egotistical Musings from Dan Wood, co-owner of Karelia Software. This blog mostly covers geeky topics like Mac Programming." />

<link rel="alternate" type="application/rss+xml" title="RSS" href="http://gigliwood.com/weblog/index.rss" />



<style type="text/css">

/* color palette: tinyurl.com/tgq5o */

body {
	background:#9191FF;
	margin:0;
	padding:0;
	font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size:76%;
	word-wrap:break-word;
	}


pre { word-wrap:normal !important;
		font:9px monaco;
		margin-right:-3px;
	background:white; padding: 3px; overflow:auto; }


.bio { font-size:80%; margin:auto; text-align:center; padding:10px 40px; }
.description { clear:all; color:white; font-weight:bold; font-size:120%; margin:auto; text-align:center; }

.categories { text-align:center; border-top:1px dashed #888; border-bottom:1px dashed #888; }

#frame {
	margin-left:auto;
	margin-right:auto;
	padding:0px;
	width:785px;
	overflow:auto;
	margin-bottom:80px;
	}
	
#heady {
	background:#12127D;
	color:#B37D00;
	padding:20px 10px 10px 10px;
}

#heady a:link              { color:#FFB200; text-decoration:underline; }
#heady a:visited           { color:#FFB200; text-decoration:none; }
#heady a:hover             { color:#C8C8FF; text-decoration:underline; }
#heady a:active            { color:#FFFFFF; text-decoration:underline; }

h1, h2, h3, h4 {
	margin:0;
}

h1 {
	padding-bottom:20px;
	font-weight:normal;
	font-family:Zapfino, Georgia, serif;
	text-shadow:white 0 0 20px;
	text-align:center;
}
	
#contentcenter {
	width: 565px;
	}

div.dateHeader {
	text-align:right;
	padding:5px;
	font-weight:bold;
	}

/* holds one item */
div.item {
	background:white;
	overflow:auto;
	}

/* sub-holds one item */
div.row {
  		}

div.row .label {
		float: left;
		width: 105px;
		}
		
p.postinfo {
		text-align: right;
		padding:10px 10px 5px 5px;
		font-size:70%;
		margin:0;
}
		
.label h2 {
	color:#12127D;
	font-size:140%;
	background:#ffB200;
	text-shadow:white 2 0 2px;
	padding:5px;
	margin:0;
	font-family:Georgia, serif;
	font-weight:normal;
}

.label img {
	padding:3px 0;
}

.label a:link              { color:#1919B3; text-decoration:none; }
.label a:visited           { color:#9191FF; text-decoration:none; }
.label a:hover             { color:#12127D; text-decoration:underline; }
.label a:active            { color:#B37D00; text-decoration:underline; }


div.row .value {
		float: left;
		width: 440px;
		text-align: left;
		padding:0 10px 60px 10px;
		background:#FFECBF;
		font-family:Georgia, serif;  font-size:110%;
		}

.value a:link              { color:#1919B3; text-decoration:none; }
.value a:visited           { color:#9191FF; text-decoration:none; }
.value a:hover             { color:#12127D; text-decoration:underline; }
.value a:active            { color:#B37D00; text-decoration:underline; }


#sidebar {
	background:#FFD980;
	width:200px;
	padding:20px 10px 80px 10px;
	height:100%;
	text-align:center;
	float:right;
	font-size:80%;
	}

#sidebar a:link              { color:#1919B3; font-weight:normal; text-decoration:underline; }
#sidebar a:visited           { color:#9191FF; font-weight:bold; text-decoration:none; }
#sidebar a:hover             { color:#12127D; font-weight:bold; text-decoration:underline; }
#sidebar a:active            { color:#B37D00; font-weight:bold; text-decoration:underline; }
	
div.calendar {
}
table.month-calendar {
	margin-left:auto;
	margin-right:auto;
	width:80%;
}

.month-calendar, .year-calendar {
	border-collapse:	collapse; 
}
.month-calendar-head, .year-calendar-head {
	background:		#cccccc;
	font-size:		110%;
	font-weight:		bold;
}
.month-calendar-day-head, .year-calendar-subhead {
	font-weight:		normal;
}

.month-calendar-day-noday,
.month-calendar-day-link,     .year-calendar-month-link,
.month-calendar-day-nolink,   .year-calendar-month-nolink,
.month-calendar-day-this-day, .year-calendar-this-month,
.month-calendar-day-future,   .year-calendar-month-future  {
	text-align:		center;
}

.month-calendar-day-future, .year-calendar-month-future {
	color:			#83660F;
}

.Saturday, .Sunday {
	background:		#eeeeee;
}

.month-calendar-day-this-day, .year-calendar-this-month {
	background:		#a5e4ff;
}

</style>

</head>

<body>
<div id="frame">
	<div id="heady">
		<h1>Dan Wood: The Eponymous Weblog <span style="font-size:70%;">(Archives)</span></h1>
		<p class="bio">
			<img style="float:right; margin-top:-20px; border:2px solid gray;" src="http://gigliwood.com/weblogpix/dan_wood.jpeg
" alt="Dan Wood" height="82" width="49" />
		<i>Dan Wood is co-owner of <a href="http://www.karelia.com/">Karelia Software</a>, creating programs for the Macintosh computer.  He is the father of two kids, lives in the Bay Area of California USA, and prefers bicycles to cars.  This site is his older weblog, which mostly covers geeky topics like Macs and Mac Programming.  <a href="http://gigliwood.com/blog">Go visit the current blog here.</a></i>
		</p>
		<p class="description">Useful Tidbits and Egotistical Musings from Dan Wood</p>
		<p class="categories"> <em>Categories:</em> 
		<a href="../Business/index.html">Business</a> &middot; 
		<a href="../MacOSX/index.html">Mac OS X</a> &middot; 
		<a href="index.html">Cocoa Programming</a> &middot; 
		<a href="../General/index.html">General</a> &middot; 
		<a href="../index.html"><b>All Categories</b></a>
		</p>
	</div>
	<div id="sidebar">
		<h3>Calendar</h3>
		<div class="calendar">
			<table class="month-calendar"><caption class="month-calendar-head"><a title="July 2008 (4)" href="../2008/07/index.html">&larr;</a><a title="August 2008 (4)" href="../2008/08/index.html">August</a><a title="September 2008 (1)" href="../2008/09/index.html">&rarr;</a></caption>
<tr>
<th class="month-calendar-day-head Sunday">Sun</th>
<th class="month-calendar-day-head Monday">Mon</th>
<th class="month-calendar-day-head Tuesday">Tue</th>
<th class="month-calendar-day-head Wednesday">Wed</th>
<th class="month-calendar-day-head Thursday">Thu</th>
<th class="month-calendar-day-head Friday">Fri</th>
<th class="month-calendar-day-head Saturday">Sat</th>
</tr>
<tr>
<td class="month-calendar-day-noday Sunday">&nbsp;</td>
<td class="month-calendar-day-noday Monday">&nbsp;</td>
<td class="month-calendar-day-noday Tuesday">&nbsp;</td>
<td class="month-calendar-day-noday Wednesday">&nbsp;</td>
<td class="month-calendar-day-noday Thursday">&nbsp;</td>
<td class="month-calendar-day-nolink Friday">1</td>
<td class="month-calendar-day-nolink Saturday">2</td>
</tr>
<tr>
<td class="month-calendar-day-nolink Sunday">3</td>
<td class="month-calendar-day-link Monday"><a title="Monday, 4 August 2008 (1)" href="../2008/08/04/index.html">4</a></td>
<td class="month-calendar-day-nolink Tuesday">5</td>
<td class="month-calendar-day-nolink Wednesday">6</td>
<td class="month-calendar-day-nolink Thursday">7</td>
<td class="month-calendar-day-link Friday"><a title="Friday, 8 August 2008 (1)" href="../2008/08/08/index.html">8</a></td>
<td class="month-calendar-day-nolink Saturday">9</td>
</tr>
<tr>
<td class="month-calendar-day-nolink Sunday">10</td>
<td class="month-calendar-day-nolink Monday">11</td>
<td class="month-calendar-day-nolink Tuesday">12</td>
<td class="month-calendar-day-nolink Wednesday">13</td>
<td class="month-calendar-day-nolink Thursday">14</td>
<td class="month-calendar-day-nolink Friday">15</td>
<td class="month-calendar-day-nolink Saturday">16</td>
</tr>
<tr>
<td class="month-calendar-day-nolink Sunday">17</td>
<td class="month-calendar-day-nolink Monday">18</td>
<td class="month-calendar-day-nolink Tuesday">19</td>
<td class="month-calendar-day-nolink Wednesday">20</td>
<td class="month-calendar-day-nolink Thursday">21</td>
<td class="month-calendar-day-nolink Friday">22</td>
<td class="month-calendar-day-nolink Saturday">23</td>
</tr>
<tr>
<td class="month-calendar-day-nolink Sunday">24</td>
<td class="month-calendar-day-nolink Monday">25</td>
<td class="month-calendar-day-nolink Tuesday">26</td>
<td class="month-calendar-day-nolink Wednesday">27</td>
<td class="month-calendar-day-nolink Thursday">28</td>
<td class="month-calendar-day-nolink Friday">29</td>
<td class="month-calendar-day-this-day Saturday"><a title="Saturday, 30 August 2008 (current) (2)" href="../2008/08/30/index.html">30</a></td>
</tr>
<tr>
<td class="month-calendar-day-nolink Sunday">31</td>
<td class="month-calendar-day-noday Monday">&nbsp;</td>
<td class="month-calendar-day-noday Tuesday">&nbsp;</td>
<td class="month-calendar-day-noday Wednesday">&nbsp;</td>
<td class="month-calendar-day-noday Thursday">&nbsp;</td>
<td class="month-calendar-day-noday Friday">&nbsp;</td>
<td class="month-calendar-day-noday Saturday">&nbsp;</td>
</tr>
</table>

		</div>

		<h3><a href="http://amzn.com/w/2663V7TM8IKKC">My Amazon WishList</a></h3>


		<p>Subscribe:
		   <a href="http://gigliwood.com/weblog/index.rss" title="RSS Feed for this category; drag link into a news reader program."><img  src="http://gigliwood.com/weblogpix/rss.gif" alt="RSS" border="0" /></a>
		</p>
		<p>
				<a href="mailto: dan at this domain">Feedback</a></i>
		</p>
		
		<p>
			<b>Also on this website</b>
			<a href="http://gigliwood.com/abcd/">A Basic Course in Dvorak</a> &middot;
			<a href="http://gigliwood.com/kenwood/Pickle/">The Pickle Machine</a> &middot;
			<a href="http://gigliwood.com/mentos/">The Mentos Gallery</a> &middot;
			<a href="http://gigliwood.com/tabletester">Cocoa Table Tester</a> &middot;
			<a href="http://gigliwood.com/wedding">Making your Wedding Make a Difference</a> &middot;
			</p>
		<p>
			<b>Sites I also work on</b>
			<a href="http://www.bikealameda.org/">BikeAlameda</a> &middot;
			<a href="http://progala.blogspot.com/">A Progressive Alamedan (my political blog)</a> &middot;
			<a href="http://www.karelia.com/">Karelia Software</a>
		</p>
		
		<p>
			<b>I'm also here:</b>
			<a href="http://twitter.com/danwood">danwood</a> on Twitter
		</p>
	</div> <!-- end sidebar -->

	<div id="contentcenter">





<div class="dateHeader">Sat, 30 Aug 2008</div>
<div class="item">
	<div class="row">
		<div class="label">
			<h2>Clang's Empirical Demonstration of a Need for Defensive Coding Guidelines</h2>
			<p class="postinfo">
				<a href="Clang_s_Empirical_D.html">permanent link</a>
				&middot; Topic<a href="../Cocoa/">/Cocoa</a>
				<br />
				<a href="../Cocoa/"><img border="0" src="http://gigliwood.com/weblogpix/Cocoa.gif" alt="/Cocoa" /></a>
				
			</p>
		</div>
		<div class="value"><p>
At the job that I had before starting Karelia Software, around the turn of the century, our software engineering department had a fairly intense set of coding guidelines.  Not just the formatting rules that people had to follow (e.g. no K&amp;R braces, indentation rules, etc.) but also many guidelines that were about programming <i>defensively</i>.  The idea was that you had to write code that was less likely to have errors in it, and was less likely to have errors introduced later on.
</p>
<p>
Although the guidelines were originally written for C++ (for old-school Mac development), a lot of the rules transferred easily to Java (as did the many of the developers!), and then, with me, when I went "indie," to Objective-C.
</p>
<p>
I don't have a copy of that document, alas, but I did manage to internalize many of those rules, so that it became habit for me (for the most part), and I've been able to add on to some of those rules to be specific to Objective-C/Cocoa programming.
</p>
<p>
A few days ago, I found out about the <a href="http://clang.llvm.org/StaticAnalysis.html"> LLVM/Clang Static Analyzer</a> &mdash; "Clang" for short &mdash; from a number of developers on <a href="http://twitter.com/">Twitter</a> (where I am "danwood", BTW, and a lot more active there than on this blog these days).  I ran our codebase (Sandvox, along with the iMedia Browser and other bits of code) through the analyzer, and what I found was very interesting: <b>Most of the bugs that it found, if we had better applied the guidelines we've been <i>trying</i> to follow, would not have been there</b>.  I consider this proof of the utility of these kinds of guidelines, which I'll list later on here.
</p>
<hr class="seemore">


<p>
Clang, at this early stage in its development, is able to catch several kinds of bugs, including the following:
</p>
<dl>
	<dd>Memory Leaks</dd><dt>Clang is great at finding places where you have allocated (or copied) an object and neglected to release it; it even follows branches in your code to find that corner case where memory leaks.  Most of these can be fixed with a <tt>CFRelease</tt> or <tt>release</tt> or <tt>autorelease</tt>, though I'll explain which one I prefer later on.</dt>
	<dd>Dead Store</dd><dt>If you store a value to a local variable, but then never make use of that variable, it's not a big deal.  However, in a lot of cases this may actually point out a flaw in your logic; why were you saving a value away and then not using it? </dt>
	<dd>Use After Release</dd><dt>This can be pretty nasty if your code encounters it, so it's good to find places where you are making use of a variable that you have already released.  Can you say "Zombie"?</dt>
	<dd>Bad Receiver</dd><dt>If you have a variable that is not initialized, and then you send a message to it, you could crash your program.</dt>
	<dd>Null Dereference</dd><dt>If you reference a pointer that is nil, this is a bad thing.</dt>
	<dd>Missing Dealloc</dd><dt>This test in Clang isn't quite ready for prime time yet, but it's a great concept.  Ideally, if you have a class with instance variables, they should be released in the <tt>dealloc</tt> method. I look forward to this being fully implemented because this is one area where I find myself making a lot of mistakes; I haven't figured out any kind of way to code defensively when it comes to getting instance variables deallocated.</dt>
</dl>
<p>(There may be other conditions that Clang catches; I just haven't run across them yet. And I'm sure the team is working on some other cool things to analyze!)</p>
<p>
So now that we have this tool available, it's great that it can help clean up our mess for us, but that's no excuse for sloppy coding.  It's still a lot easier just to get it right the first time. So what are some ways you can program defensively?
</p>
<p>
Before I get into a list, I should point out that you have to write code with this mindset: that someday, sooner or later, somebody &mdash; you or somebody else &mdash; is going to touch your code.  If it's somebody else, they are not going to know what you know right now as you type in code. And if it's future-you, you aren't going to <i>remember</i> what is in your head right now.  So don't try to be clever.  Whoever it is, they are going to have to understand what you were doing, and then they are going to do something to change the code which you thought you had made just perfectly.  Don't make it easy for them to mess something up.
</p>
<p>
For the "understanding" part, it obviously makes sense to use clear naming and comment your code.  We've all heard that, and maybe we even follow those guidelines occasionally.  Well, do that stuff more.
</p>
<p>
The "changing" part is a lot more dangerous.  Somebody might go in and put an autorelease pool around the outside of your algorithm to deal with memory management.  Or maybe they will find that they have to insert a line of code in there.  Or they will rearrange the order of the lines for some reason.  You have to write your code with that in mind, because you want it to be hard for that person to make mistakes.
</p>
<p>
Without further ado, here are some guidelines that I try to follow.  Some of these, but not all, are directly related to issues that Clang has caught. (If you have any of your own to suggest, add them to the comments please!)
</p>
<dl>
	<dd>Manage your memory</dd><dt>Use <tt>autorelease</tt> for crying out loud.  Yes, it seems more efficient to just allocate your object, do something with it, and then release it below.  Easy, right?  Except that time after time in our code, Clang found cases where this didn't work.  Maybe there was a <tt>break</tt> in a loop in a certain branch that prevented the <tt>release</tt> from being reached, or there was a <tt>return</tt> under unusual conditions that exited the method without cleaning up.  And most of the time, somebody just forgot to put in the <tt>release</tt>.  So just get in the habit of autoreleasing all the time.  (If you have to work with Core Foundation objects, cast and then autorelease those too if you can!)  Don't prematurely optimize; you can always put autorelease pool into action if memory management is an issue.  And if you <i>really</i> have to explicitly retain and release something (such as the autorelease pool itself), be sure to boldly comment what you are up to; following the next guideline below will also help avoid problems.</dt>
	<dd>Avoid early <tt>return</tt></dd><dt>It's harder to look at a block of code riddled with <tt>return</tt> statements and figure out the flow of things, and therefore it's easier to make mistakes. Clang proved this quite definitively!  If you have cleanup to do (such as releasing an autorelease pool), this will prevent your cleanup from happening.  It's just a lot clearer if you let your code flow to the end of the method where you can return the result that you have stored into a variable.  (I tend to always have a "result" variable.) Remember, your code may be fine now, but somebody may come along and change things, and not notice all of your early <tt>return</tt> statements and clean things up properly.</dt>
	<dd>Initialize your local variables.</dd><dt>When you declare a local variable, initialize it to something safe.  Yes, you may get a few "dead store" warnings from Clang, but it's better than to get "bad receiver" warnings &mdash; or worse &mdash; crashes at runtime.  If somebody comes along and modifies your code later, your uninitialized variable could come back to haunt you. </dt>
	<dd>Release using setters</dd><dt>You can avoid zombies if you get in the habit of releasing your instance variables only in their setters.  If you call <tt>[foo release]</tt> in your method, there's a chance that somebody may later try to make use of <tt>foo</tt> and cause bad things to happen. If you call a method like <tt>[self setFoo:nil]</tt> then you're safer.  Clang found a few cases where we didn't do this; if we had then this problem would not have happened.</dt>
	<dd>Use your return codes</dd><dt>Methods or functions that return something to you are probably returning something useful, so it's not a good idea to just ignore a result, especially if it could help you track down a problem.  You can also tell what happened if you are stepping through your code with a debugger. If you really don't need the result of calling something, cast its return value to <tt>(void)</tt> so it's clear that you intended to ignore the result.</dt>
	<dd>Always use { } braces in nested blocks</dd><dt>Sure, it's possible to put just one statement after an <tt>if</tt> or <tt>while</tt>... but you are just asking for trouble.  That person who modifies your code in the future may want to insert another statement in that block of code, not notice that there weren't braces there.  Your program logic could get really screwed up.  It's better just to put the braces there in the first place, even if it's just a single line in between.  (Don't expect Clang to catch this kind of problem; unless it starts analyzing the indentation levels of your source files!)</dt>
	<dd>Put constants on the left side of the <tt>==</tt></dd><dt>This is a good habit in order to avoid the mistake of only a single <tt>=</tt> when you meant the double <tt>==</tt>.  A constant to the left of a single <tt>=</tt> will alert you right away.</dt>
</dl>
<p>
There you have it!  Check out Clang and see what it can find in your own code, and try to think of how you can change your habits so that those kinds of problems won't crop up again.
</p></div>
	</div>
</div>
	</div> <!-- end contentCenter -->
</div> <!-- end frame -->

</body>
</html>

